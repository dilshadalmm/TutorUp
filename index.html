<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Disable zoom and ensure fluid width for mobile usability -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revision Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel Standalone (for JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts: Oswald (Bold and modern, requested font) -->
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Oswald', sans-serif; 
            font-weight: 700; /* Set all text to bold as requested */
            user-select: none; 
            -webkit-user-select: none; 
            -moz-user-select: none; 
            -ms-user-select: none; 
            touch-action: manipulation;
        }
        /* Override tailwind classes to ensure everything is bold */
        .font-normal, .font-medium, .font-light { font-weight: 700 !important; }

        /* Smooth transitions */
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Remove default date input icon for custom visual placement */
        input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0; }
        input[type="date"] { cursor: pointer; }
        
        /* Ensure no horizontal scroll */
        .overflow-x-auto { overflow-x: auto; }
        .overflow-hidden { overflow: hidden; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">

    <div id="root"></div>

    <!-- Firebase Setup (Module Script) -->
    <script type="module">
        // Import all necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged,
            signInWithCustomToken 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            doc, 
            updateDoc, 
            deleteDoc, 
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        
        // Set Debug logging for Firestore
        setLogLevel('debug'); 

        // Expose Firebase modules to the global scope for the Babel script
        window.FirebaseTools = {
            initializeApp,
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken,
            getFirestore,
            collection,
            addDoc,
            query,
            onSnapshot,
            doc,
            updateDoc,
            deleteDoc,
            serverTimestamp,
            setLogLevel 
        };
        
        // Signal that modules are loaded
        window.dispatchEvent(new Event('firebase-ready', { bubbles: true }));
    </script>

    <!-- React App Logic (Babel Script) -->
    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icons (Inline SVGs to remove external dependencies) ---
        const Icon = ({ path, className, fill = "none" }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                viewBox="0 0 24 24" 
                fill={fill} 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className}
            >
                {path}
            </svg>
        );

        const Icons = {
            BookOpen: (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />,
            Plus: (props) => <Icon {...props} path={<><path d="M5 12h14"/><path d="M12 5v14"/></>} />,
            CheckCircle2: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></>} />,
            Circle: (props) => <Icon {...props} path={<circle cx="12" cy="12" r="10"/>} />,
            AlertCircle: (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></>} />,
            Trash2: (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></>} />,
            LayoutDashboard: (props) => <Icon {...props} path={<><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></>} />,
            List: (props) => <Icon {...props} path={<><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></>} />,
            CalendarDays: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></>} />,
            Image: (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />,
            X: (props) => <Icon {...props} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />,
        };

        // --- Helper Functions ---
        const getLocalDateString = (date = new Date()) => {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const addDays = (dateStr, days) => {
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return getLocalDateString(date);
        };

        const formatDateDisplay = (dateStr) => {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        };

        const getRevisionStatus = (targetDate, isCompleted) => {
            if (isCompleted) return 'completed';
            const today = getLocalDateString();
            if (targetDate === today) return 'due';
            if (targetDate < today) return 'missed';
            return 'future';
        };

        // --- Custom Confirmation Modal (Replaces window.confirm) ---
        const ConfirmationModal = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 fade-in">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6">
                        <h3 className="text-xl font-bold text-gray-800 mb-2">{title}</h3>
                        <p className="text-gray-600 mb-6 text-sm font-normal">{message}</p>
                        <div className="flex justify-end gap-3">
                            <button
                                onClick={onCancel}
                                className="px-4 py-2 text-sm font-medium text-gray-600 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                onClick={onConfirm}
                                className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors shadow-md"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Sub-Components (omitted for brevity, assume they are correct) ---
        
        const RevisionBubble = ({ label, date, status, onClick }) => {
            const styles = {
                completed: 'bg-green-100 text-green-700 border-green-200',
                due: 'bg-blue-100 text-blue-700 border-blue-400 ring-1 ring-blue-400',
                missed: 'bg-red-100 text-red-700 border-red-200',
                future: 'bg-gray-50 text-gray-300 border-gray-100',
            };

            return (
                <div 
                    onClick={status !== 'future' ? onClick : undefined}
                    className={`flex flex-col items-center justify-center p-2 rounded-lg border w-full transition-all ${styles[status] || styles.future} ${status !== 'future' ? 'cursor-pointer active:scale-95' : ''}`}
                >
                    <span className="text-[10px] uppercase font-bold tracking-wider mb-1">{label}</span>
                    <div className="h-5 flex items-center justify-center">
                        {status === 'completed' ? <Icons.CheckCircle2 className="w-4 h-4" /> :
                        status === 'due' ? <Icons.Circle className="w-4 h-4 fill-blue-500 text-blue-600" /> :
                        status === 'missed' ? <Icons.AlertCircle className="w-4 h-4" /> :
                        <span className="text-[10px] font-medium">{formatDateDisplay(date).split(' ')[0]}</span>}
                    </div>
                </div>
            );
        };

        const RevisionCell = ({ chapter, type, onToggle }) => {
            const revision = chapter.schedule[type];
            if (!revision) return <td className="p-3"></td>;

            const status = getRevisionStatus(revision.date, revision.completed);
            
            const baseClasses = "p-2 border text-center transition-colors duration-200 cursor-pointer relative";
            const statusClasses = {
                completed: "bg-green-50 hover:bg-green-100",
                due: "bg-blue-50 hover:bg-blue-100 ring-2 ring-inset ring-blue-300",
                missed: "bg-red-50 hover:bg-red-100",
                future: "bg-gray-50 text-gray-400 cursor-default",
            };

            const handleClick = () => {
                if (status !== 'future') {
                    onToggle(chapter.id, type, !revision.completed);
                }
            };

            return (
                <td 
                    className={`${baseClasses} ${statusClasses[status]}`}
                    onClick={handleClick}
                >
                    <div className="flex flex-col items-center justify-center gap-1">
                        <span className="text-xs font-medium">{formatDateDisplay(revision.date)}</span>
                        {status === 'completed' && <Icons.CheckCircle2 className="w-4 h-4 text-green-600" />}
                        {status === 'due' && <Icons.Circle className="w-4 h-4 text-blue-600 fill-blue-200" />}
                        {status === 'missed' && <Icons.AlertCircle className="w-4 h-4 text-red-500" />}
                    </div>
                </td>
            );
        };

        // --- Main Application ---
        const App = () => {
            // State initialization
            const [user, setUser] = useState(null);
            const [chapters, setChapters] = useState([]);
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('dashboard');
            const [showAddForm, setShowAddForm] = useState(false); 
            
            const [newChapterName, setNewChapterName] = useState('');
            const [studyDate, setStudyDate] = useState(getLocalDateString());
            const [newChapterImageUrl, setNewChapterImageUrl] = useState('');
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [expandedTaskId, setExpandedTaskId] = useState(null); 
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [chapterToDelete, setChapterToDelete] = useState(null);

            // Firebase Refs
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [appId, setAppId] = useState('default-app-id');
            const [isFirebaseReady, setIsFirebaseReady] = useState(false); // New flag for module load

            // 1. Module Ready Listener
            useEffect(() => {
                const checkFirebaseReady = () => {
                    if (window.FirebaseTools) {
                        setIsFirebaseReady(true);
                        window.removeEventListener('firebase-ready', checkFirebaseReady);
                    }
                };
                window.addEventListener('firebase-ready', checkFirebaseReady);
                // In case the event already fired
                checkFirebaseReady(); 
                
                return () => window.removeEventListener('firebase-ready', checkFirebaseReady);
            }, []);

            // 2. Firebase Initialization and Auth (Runs once FirebaseTools is available)
            useEffect(() => {
                if (!isFirebaseReady) return;

                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore } = window.FirebaseTools;

                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                const currentAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                setAppId(currentAppId);

                if (firebaseConfig) {
                    const app = initializeApp(firebaseConfig);
                    const authInstance = getAuth(app);
                    const dbInstance = getFirestore(app);
                    
                    setAuth(authInstance);
                    setDb(dbInstance);
                    console.log("Firebase services initialized.");

                    const initAuth = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(authInstance, __initial_auth_token);
                                console.log("Signed in with custom token.");
                            } else {
                                await signInAnonymously(authInstance);
                                console.log("Signed in anonymously.");
                            }
                        } catch (error) {
                            console.error("Firebase Auth Error: Failed to sign in.", error);
                        }
                    };
                    initAuth();

                    const unsubscribe = onAuthStateChanged(authInstance, (currentUser) => {
                        setUser(currentUser);
                        if (currentUser) {
                            console.log("User authenticated. UID:", currentUser.uid);
                        } else {
                             // This should only happen if sign-in fails or user logs out.
                             setLoading(false);
                        }
                    });
                    return () => unsubscribe();
                } else {
                    console.error("Firebase config not found.");
                    setLoading(false);
                }
            }, [isFirebaseReady]);

            // 3. Data Fetching (Runs only after User and DB are set)
            useEffect(() => {
                if (!user || !db) return;
                
                const { collection, query, onSnapshot } = window.FirebaseTools;
                if (!collection || !query || !onSnapshot) {
                     console.error("Data fetching blocked: Firebase functions not available.");
                     return;
                }

                const chaptersRef = collection(db, 'artifacts', appId, 'users', user.uid, 'chapters');
                const q = query(chaptersRef);

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const fetchedChapters = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    fetchedChapters.sort((a, b) => new Date(b.studyDate) - new Date(a.studyDate));
                    setChapters(fetchedChapters);
                    setLoading(false); // Set loading to false only after data is received
                    console.log(`Fetched ${fetchedChapters.length} chapters.`);
                }, (error) => {
                    console.error("Error fetching chapters:", error);
                    setLoading(false);
                });

                return () => unsubscribe();
            }, [user, db, appId]); // Dependencies check for full readiness

            // Handlers
            
            // Use useCallback for stability and ensure all dependencies are checked for the submission fix
            const handleAddChapter = useCallback(async (e) => {
                e.preventDefault();
                
                const { collection, addDoc, serverTimestamp } = window.FirebaseTools || {};
                
                if (!newChapterName.trim() || !user || !db || !collection || !addDoc || !serverTimestamp) {
                    const errorDetails = {
                        name: newChapterName.trim(),
                        userReady: !!user,
                        dbReady: !!db,
                        collectionFunc: !!collection,
                        addDocFunc: !!addDoc,
                        serverTimestampFunc: !!serverTimestamp,
                    };
                    console.error("CRITICAL ERROR: Submission blocked because a required dependency is missing. Details:", errorDetails);
                    // Add a visible indicator to the user if possible (though we can't use alert)
                    // For now, rely on console logs.
                    return;
                }
                
                setIsSubmitting(true);
                
                const schedule = {
                    d1: { date: addDays(studyDate, 1), completed: false },
                    d3: { date: addDays(studyDate, 3), completed: false },
                    d7: { date: addDays(studyDate, 7), completed: false },
                    d15: { date: addDays(studyDate, 15), completed: false },
                    d31: { date: addDays(studyDate, 31), completed: false },
                };

                try {
                    const docRef = await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'chapters'), {
                        name: newChapterName,
                        studyDate: studyDate,
                        imageUrl: newChapterImageUrl.trim() || null,
                        schedule: schedule,
                        createdAt: serverTimestamp()
                    });
                    console.log("Chapter added successfully with ID:", docRef.id);
                    
                    // Reset form fields
                    setNewChapterName('');
                    setNewChapterImageUrl('');
                    setShowAddForm(false); 
                } catch (err) {
                    console.error("Error adding chapter to Firestore:", err);
                } finally {
                    setIsSubmitting(false);
                }
            }, [newChapterName, studyDate, newChapterImageUrl, user, db, appId]);

            const handleToggleRevision = async (chapterId, revisionKey, newValue) => {
                const { doc, updateDoc } = window.FirebaseTools || {};
                if (!user || !db || !doc || !updateDoc) return;

                const chapter = chapters.find(c => c.id === chapterId);
                if (!chapter) return;

                const updatedSchedule = {
                    ...chapter.schedule,
                    [revisionKey]: {
                        ...chapter.schedule[revisionKey],
                        completed: newValue
                    }
                };

                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'chapters', chapterId);
                    await updateDoc(docRef, { schedule: updatedSchedule });
                } catch (err) {
                    console.error("Error updating revision:", err);
                }
            };

            const confirmDelete = (chapterId) => {
                setChapterToDelete(chapterId);
                setIsModalOpen(true);
            };

            const handleExecuteDelete = async () => {
                const { doc, deleteDoc } = window.FirebaseTools || {};
                if (!chapterToDelete || !user || !db || !doc || !deleteDoc) return;
                
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'chapters', chapterToDelete));
                } catch (err) {
                    console.error("Error deleting chapter:", err);
                } finally {
                    setIsModalOpen(false);
                    setChapterToDelete(null);
                }
            };

            const handleCancelDelete = () => {
                setIsModalOpen(false);
                setChapterToDelete(null);
            };
            
            const handleViewImage = (url) => {
                window.open(url, '_blank');
            };

            const handleToggleImagePreview = (taskId) => {
                setExpandedTaskId(prevId => prevId === taskId ? null : taskId);
            };

            // Derived Data (omitted for brevity, assume correct)
            const todaysTasks = useMemo(() => {
                const today = getLocalDateString();
                const tasks = [];
                chapters.forEach(chapter => {
                    Object.entries(chapter.schedule || {}).forEach(([key, data]) => {
                        if (!data.completed) {
                            if (data.date === today) {
                                tasks.push({ ...chapter, revisionType: key, revisionDate: data.date, status: 'due' });
                            } else if (data.date < today) {
                                tasks.push({ ...chapter, revisionType: key, revisionDate: data.date, status: 'missed' });
                            }
                        }
                    });
                });
                return tasks.sort((a, b) => new Date(a.revisionDate) - new Date(b.revisionDate));
            }, [chapters]);

            const stats = useMemo(() => {
                let completed = 0;
                let total = 0;
                chapters.forEach(c => {
                    Object.values(c.schedule || {}).forEach(s => {
                        if (s.date <= getLocalDateString()) {
                            total++;
                            if (s.completed) completed++;
                        }
                    });
                });
                return { completed, total };
            }, [chapters]);

            // Loading State (Check for all readiness flags)
            if (loading || !isFirebaseReady || !db || !auth || !user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-50 text-gray-500">
                        <div className="animate-spin mr-2">
                            <Icons.Circle className="w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full" />
                        </div>
                        <p>Initializing app and authenticating...</p>
                    </div>
                );
            }

            // Render
            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans pb-20 overflow-hidden w-full">
                    
                    {/* Confirmation Modal */}
                    <ConfirmationModal
                        isOpen={isModalOpen}
                        title="Confirm Deletion"
                        message="Are you sure you want to permanently delete this chapter's tracking data? This action cannot be undone."
                        onConfirm={handleExecuteDelete}
                        onCancel={handleCancelDelete}
                    />

                    {/* Header */}
                    <header className="bg-white border-b sticky top-0 z-20">
                        <div className="max-w-4xl mx-auto px-4 h-16 flex items-center justify-between">
                            
                            {/* Logo Name */}
                            <div className="flex items-center gap-2">
                                <Icons.BookOpen className="w-6 h-6 text-blue-600" />
                                <h1 className="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">
                                    Dilshad <span className="font-normal text-gray-500">Alam</span>
                                </h1>
                            </div>

                            {/* Date & Add Button */}
                            <div className="flex items-center gap-3">
                                <div className="text-xs font-medium text-gray-500 hidden sm:block">
                                    {new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' })}
                                </div>
                                <button
                                    onClick={() => setShowAddForm(prev => !prev)}
                                    className={`p-2 rounded-full transition-colors active:scale-95 shadow-md ${showAddForm ? 'bg-red-500 hover:bg-red-600 text-white' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                                    title={showAddForm ? 'Hide Form' : 'Add New Chapter'}
                                >
                                    {showAddForm ? <Icons.X className="w-5 h-5" /> : <Icons.Plus className="w-5 h-5" />}
                                </button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-4xl mx-auto p-4 space-y-6 w-full overflow-hidden">

                        {/* Input Form Section */}
                        {showAddForm && (
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 fade-in">
                                <div className="bg-white p-4 rounded-xl border shadow-lg md:col-span-3">
                                    <h2 className="text-sm font-semibold text-gray-400 mb-3 uppercase tracking-wider">New Entry</h2>
                                    <form onSubmit={handleAddChapter} className="flex flex-col gap-3">
                                        
                                        {/* Chapter Name & Image URL (Row 1) */}
                                        <div className="flex flex-col sm:flex-row gap-3">
                                            <input 
                                                type="text" 
                                                value={newChapterName}
                                                onChange={(e) => setNewChapterName(e.target.value)}
                                                placeholder="Chapter Name (e.g. Optics)"
                                                className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all w-full font-normal"
                                                required
                                            />
                                            <input 
                                                type="url" 
                                                value={newChapterImageUrl}
                                                onChange={(e) => setNewChapterImageUrl(e.target.value)}
                                                placeholder="Paste Image URL (Optional)"
                                                className="flex-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all w-full font-normal"
                                            />
                                        </div>

                                        {/* Date & Button (Row 2) */}
                                        <div className="flex flex-col sm:flex-row gap-3 items-stretch">
                                            
                                            {/* Date Input with Custom Icon */}
                                            <div className="relative flex-1 sm:w-40 flex-shrink-0">
                                                <Icons.CalendarDays className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400 pointer-events-none" />
                                                <input 
                                                    type="date" 
                                                    value={studyDate}
                                                    onChange={(e) => setStudyDate(e.target.value)}
                                                    className="w-full pl-9 pr-3 py-2 border rounded-lg bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none text-sm appearance-none font-normal"
                                                />
                                            </div>

                                            <button 
                                                type="submit"
                                                disabled={isSubmitting || !newChapterName.trim()}
                                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center justify-center gap-2 transition-colors disabled:opacity-50 flex-1 sm:flex-none sm:w-24 shadow-md"
                                            >
                                                <Icons.Plus className="w-5 h-5" />
                                                <span className="whitespace-nowrap">Add Entry</span>
                                            </button>
                                        </div>

                                    </form>
                                </div>
                            </div>
                        )}

                        {/* Navigation Tabs (omitted for brevity) */}
                        <div className="flex bg-white p-1 rounded-xl border shadow-sm w-full sm:w-fit mx-auto sm:mx-0">
                            <button 
                                onClick={() => setView('dashboard')}
                                className={`flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${view === 'dashboard' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
                            >
                                <Icons.LayoutDashboard className="w-4 h-4" />
                                <span className="whitespace-nowrap">Daily Routine</span>
                            </button>
                            <button 
                                onClick={() => setView('schedule')}
                                className={`flex-1 sm:flex-none flex items-center justify-center gap-2 px-4 py-2 rounded-lg text-sm font-medium transition-colors ${view === 'schedule' ? 'bg-blue-500 text-white shadow-md' : 'text-gray-500 hover:bg-gray-50'}`}
                            >
                                <Icons.List className="w-4 h-4" />
                                <span className="whitespace-nowrap">Full Schedule</span>
                            </button>
                        </div>

                        {/* Stats Card (omitted for brevity) */}
                        <div className="bg-white p-4 rounded-xl border shadow-sm flex flex-col justify-center">
                            <div className="flex justify-between items-end mb-2">
                                <span className="text-sm text-gray-500">Overall Completion Rate</span>
                                <span className="text-xl font-bold text-gray-800">{stats.completed} <span className="text-sm font-normal text-gray-400">/ {stats.total}</span></span>
                            </div>
                            <div className="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                <div 
                                    className="bg-gradient-to-r from-blue-500 to-indigo-500 h-full transition-all duration-500"
                                    style={{ width: `${stats.total ? (stats.completed / stats.total) * 100 : 0}%` }}
                                />
                            </div>
                        </div>

                        {/* DASHBOARD VIEW (omitted for brevity) */}
                        {view === 'dashboard' && (
                            <div className="space-y-4 fade-in">
                                <div className="flex items-center justify-between">
                                    <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2">
                                        <Icons.CheckCircle2 className="w-5 h-5 text-blue-600" />
                                        Today's Due Tasks
                                    </h2>
                                    {todaysTasks.length > 0 && (
                                        <span className="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">
                                            {todaysTasks.length} Pending
                                        </span>
                                    )}
                                </div>

                                {todaysTasks.length === 0 ? (
                                    <div className="bg-white border rounded-xl p-8 text-center shadow-sm">
                                        <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                            <Icons.CheckCircle2 className="w-8 h-8" />
                                        </div>
                                        <h3 className="text-lg font-medium text-gray-800">All caught up!</h3>
                                        <p className="text-gray-500 mt-1 text-sm font-normal">No revisions needed for today.</p>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 gap-3">
                                        {todaysTasks.map((task) => (
                                            <div 
                                                key={`${task.id}-${task.revisionType}`} 
                                                className="bg-white p-4 rounded-xl border border-gray-200 shadow-sm flex flex-col transition-all active:scale-[0.99] hover:shadow-md"
                                            >
                                                
                                                {/* Task Header Row */}
                                                <div className="flex items-center justify-between w-full">
                                                    <div className="flex-1 min-w-0 pr-4">
                                                        <div className="flex flex-wrap items-center gap-2 mb-1">
                                                            <span className="font-semibold text-gray-800 text-base truncate block w-full sm:w-auto">{task.name}</span>
                                                            <div className="flex gap-1">
                                                                <span className={`text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-wide ${task.revisionType === 'd1' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                    {task.revisionType.toUpperCase()}
                                                                </span>
                                                                {task.status === 'missed' && (
                                                                    <span className="text-[10px] bg-red-100 text-red-600 px-2 py-0.5 rounded font-medium whitespace-nowrap">
                                                                        DUE: {formatDateDisplay(task.revisionDate)}
                                                                    </span>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <div className="text-xs text-gray-400">
                                                            Studied: {formatDateDisplay(task.studyDate)}
                                                        </div>
                                                    </div>

                                                    {/* Actions: Image Toggle & Complete */}
                                                    <div className="flex items-center gap-2 flex-shrink-0">
                                                        {task.imageUrl && (
                                                            <button 
                                                                onClick={() => handleToggleImagePreview(task.id)}
                                                                className={`p-2 rounded-full transition-colors 
                                                                            ${expandedTaskId === task.id ? 'bg-sky-600 text-white hover:bg-sky-700 shadow-lg' : 'text-sky-500 hover:bg-sky-100'}`}
                                                                title={expandedTaskId === task.id ? 'Hide Image' : 'View Image'}
                                                            >
                                                                <Icons.Image className="w-5 h-5"/>
                                                            </button>
                                                        )}
                                                        <button 
                                                            onClick={() => handleToggleRevision(task.id, task.revisionType, true)}
                                                            className="group flex items-center justify-center w-10 h-10 rounded-full bg-green-500 hover:bg-green-600 transition-all shadow-md active:scale-90"
                                                            title="Mark as Complete"
                                                        >
                                                            <Icons.CheckCircle2 className="w-6 h-6 text-white" fill="white"/>
                                                        </button>
                                                    </div>
                                                </div>
                                                
                                                {/* Image Preview Area (Conditional) */}
                                                {expandedTaskId === task.id && task.imageUrl && (
                                                    <div className="mt-4 pt-4 border-t border-gray-100 w-full fade-in">
                                                        <h4 className="text-xs font-semibold text-gray-500 mb-2">Question Image:</h4>
                                                        <img 
                                                            src={task.imageUrl} 
                                                            alt={`Image for ${task.name}`} 
                                                            className="w-full max-h-96 object-contain rounded-lg border bg-white shadow-inner"
                                                            // Fallback image in case the URL is bad or load fails
                                                            onError={(e) => {
                                                                e.target.onerror = null;
                                                                e.target.src = 'https://placehold.co/400x200/ff6666/ffffff?text=Image+Load+Failed';
                                                            }}
                                                        />
                                                        <p className="text-[10px] text-gray-400 mt-2 text-center font-normal">Image pre-loaded successfully for today's task.</p>
                                                    </div>
                                                )}

                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* SCHEDULE VIEW (omitted for brevity) */}
                        {view === 'schedule' && (
                            <div className="fade-in">
                                {chapters.length === 0 ? (
                                    <div className="bg-white border rounded-xl p-8 text-center text-gray-400 shadow-sm font-normal">
                                        No chapters found. Add your first chapter using the (+) button in the header.
                                    </div>
                                ) : (
                                    <>
                                        {/* Desktop Table View */}
                                        <div className="hidden md:block bg-white border rounded-xl shadow-sm overflow-hidden">
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="bg-gray-50 border-b">
                                                        <tr>
                                                            <th className="px-4 py-3 font-medium text-gray-500 w-12">#</th>
                                                            <th className="px-4 py-3 font-medium text-gray-500 min-w-[200px]">Chapter Name</th>
                                                            <th className="px-4 py-3 font-medium text-gray-500 whitespace-nowrap">Date</th>
                                                            <th className="px-2 py-3 font-bold text-center text-gray-700 bg-gray-100 border-x w-16">D1</th>
                                                            <th className="px-2 py-3 font-bold text-center text-gray-700 bg-gray-100 border-x w-16">D3</th>
                                                            <th className="px-2 py-3 font-bold text-center text-gray-700 bg-gray-100 border-x w-16">D7</th>
                                                            <th className="px-2 py-3 font-bold text-center text-gray-700 bg-gray-100 border-x w-16">D15</th>
                                                            <th className="px-2 py-3 font-bold text-center text-gray-700 bg-gray-100 border-x w-16">D31</th>
                                                            <th className="px-2 py-3 font-medium text-gray-500 text-center w-20">Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody className="divide-y">
                                                        {chapters.map((chapter, index) => (
                                                            <tr key={chapter.id} className="hover:bg-gray-50/50 group">
                                                                <td className="px-4 py-3 text-gray-400">{chapters.length - index}</td>
                                                                <td className="px-4 py-3 font-medium text-gray-800 flex items-center gap-2">
                                                                    {chapter.name}
                                                                </td>
                                                                <td className="px-4 py-3 text-gray-500 whitespace-nowrap text-xs">{formatDateDisplay(chapter.studyDate)}</td>
                                                                
                                                                <RevisionCell chapter={chapter} type="d1" onToggle={handleToggleRevision} />
                                                                <RevisionCell chapter={chapter} type="d3" onToggle={handleToggleRevision} />
                                                                <RevisionCell chapter={chapter} type="d7" onToggle={handleToggleRevision} />
                                                                <RevisionCell chapter={chapter} type="d15" onToggle={handleToggleRevision} />
                                                                <RevisionCell chapter={chapter} type="d31" onToggle={handleToggleRevision} />
                                                                
                                                                <td className="px-2 py-3 text-center flex items-center justify-center gap-1 h-full">
                                                                    {chapter.imageUrl && (
                                                                        <button
                                                                            onClick={() => handleViewImage(chapter.imageUrl)}
                                                                            className="p-1 text-gray-400 hover:text-sky-500 hover:bg-sky-50 rounded-full transition-colors opacity-100 md:opacity-0 md:group-hover:opacity-100"
                                                                            title="View Image in New Tab"
                                                                        >
                                                                            <Icons.Image className="w-4 h-4" />
                                                                        </button>
                                                                    )}
                                                                    <button 
                                                                        onClick={() => confirmDelete(chapter.id)}
                                                                        className="p-1 text-gray-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors opacity-100 md:opacity-0 md:group-hover:opacity-100"
                                                                        title="Delete Chapter"
                                                                    >
                                                                        <Icons.Trash2 className="w-4 h-4" />
                                                                    </button>
                                                                </td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>

                                        {/* Mobile Card View */}
                                        <div className="md:hidden space-y-3">
                                            {chapters.map((chapter) => (
                                                <div key={chapter.id} className="bg-white p-4 rounded-xl border shadow-sm">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div className="flex-1 min-w-0 pr-2">
                                                            <h3 className="font-semibold text-gray-800 truncate">{chapter.name}</h3>
                                                            <div className="flex items-center gap-2 text-xs text-gray-500 mt-1">
                                                                <Icons.CalendarDays className="w-3 h-3" />
                                                                Studied: {formatDateDisplay(chapter.studyDate)}
                                                                {chapter.imageUrl && (
                                                                    <button 
                                                                        onClick={() => handleViewImage(chapter.imageUrl)}
                                                                        className="text-[10px] bg-sky-100 text-sky-600 px-2 py-0.5 rounded font-medium whitespace-nowrap flex items-center gap-1 hover:bg-sky-200 transition-colors"
                                                                        title="View image for this chapter"
                                                                    >
                                                                        <Icons.Image className="w-3 h-3"/> Image
                                                                    </button>
                                                                )}
                                                            </div>
                                                        </div>
                                                        <button 
                                                            onClick={() => confirmDelete(chapter.id)}
                                                            className="text-gray-300 hover:text-red-500 p-1 flex-shrink-0"
                                                        >
                                                            <Icons.Trash2 className="w-4 h-4" />
                                                        </button>
                                                    </div>
                                                    
                                                    {/* Revision Grid */}
                                                    <div className="grid grid-cols-5 gap-2">
                                                        {['d1', 'd3', 'd7', 'd15', 'd31'].map((type) => {
                                                            const rev = chapter.schedule[type];
                                                            return (
                                                                <RevisionBubble 
                                                                    key={type}
                                                                    label={type}
                                                                    date={rev.date}
                                                                    status={getRevisionStatus(rev.date, rev.completed)}
                                                                    onClick={() => handleToggleRevision(chapter.id, type, !rev.completed)}
                                                                />
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </>
                                )}
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // Wait for Firebase to load before rendering
        const initApp = () => {
            if (window.FirebaseTools) {
                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } else {
                // If the event listener failed, retry every 100ms
                setTimeout(initApp, 100);
            }
        };

        // Start the initialization process
        window.addEventListener('firebase-ready', initApp);
        // Fallback check in case the event was missed
        setTimeout(initApp, 500);

    </script>
</body>
</html>

