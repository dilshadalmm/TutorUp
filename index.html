<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <title>StudentPlus Static Solver</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Inter and Montserrat for the logo) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    
    <!-- KaTeX for LaTeX Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/mhchem.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* All previous styles remain the same */
        /* CRITICAL: Ensure HTML and BODY are full height and non-scrollable */
        html {
            height: 100%;
            overflow: hidden !important;
        }

        /* Use the Inter font family as default */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* CRITICAL: Prevent the main body from scrolling at all */
            overflow: hidden !important; 
            
            user-select: none;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none; 
            
            /* Prevents elastic scrolling on iOS */
            overscroll-behavior: none;
            
            /* Make body a fixed container occupying full screen */
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* App wrapper - uses dynamic viewport height for mobile keyboard stability */
        #app-wrapper {
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height (best for mobile keyboard) */
            width: 100%;
            position: absolute; /* Relative to fixed body */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden; /* Ensures only the chat container can scroll */
        }
        
        /* Ensure input fields are still selectable/editable */
        #video-code-input, #message-input {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
        }
        
        /* Style for the logo font (Montserrat) */
        .instagram-logo-font {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            font-size: 1.8rem;
        }

        /* Style for the Camera/Home buttons for a better touch target */
        .header-action-button {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        /* Improve KaTeX readability on mobile */
        .katex {
            font-size: 1.1em !important;
            text-align: left !important;
        }
        .katex-display {
            /* Allow display math to be scrollable if too wide */
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 4px;
        }

        /* --- Hide Scrollbar on Chat Container --- */
        #chat-container {
            /* Scroll is now always auto (default of overflow-y-auto is active) */
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        #chat-container::-webkit-scrollbar {
            display: none;
        }

        /* Full-width Image Container Styles */
        .full-image-container {
            width: 100%;
            margin-top: 8px;
            margin-bottom: 0; /* REMOVED bottom margin to match video player spacing */
        }
        
        .full-image-item {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 8px; /* Reduced spacing between images */
        }
        
        .full-image-item:last-child {
            margin-bottom: 0; /* Remove margin from last image */
        }
        
        .full-image-item img {
            width: 100%;
            height: auto;
            display: block;
            object-fit: contain;
        }

        /* Video Player Styles */
        .video-wrapper {
            position: relative;
            width: 100%;
            margin-bottom: 16px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .video-wrapper.chat-video-fullscreen {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) rotate(90deg) !important;
            transform-origin: center !important;
            width: 100vh !important;
            height: 100vw !important;
            max-width: none !important;
            max-height: none !important;
            z-index: 1000 !important;
            margin: 0 !important;
            border-radius: 0 !important;
        }

        .video-wrapper.chat-video-fullscreen .aspect-video {
            height: 100% !important;
            width: 100% !important;
        }

        .video-wrapper.chat-video-fullscreen iframe {
            height: 100% !important;
            width: 100% !important;
        }

        .fullscreen-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            z-index: 10;
            transition: background 0.2s;
        }

        .fullscreen-button:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        /* Desktop responsive styles */
        @media (min-width: 768px) {
            #app-wrapper {
                position: relative;
                margin: 0 auto;
                max-width: 600px;
                height: 90vh;
                max-height: 800px;
                border-radius: 0.5rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                top: 50%;
                transform: translateY(-50%);
            }
            
            #auth-wrapper {
                max-width: 500px;
                height: auto;
                max-height: 90vh;
                border-radius: 1rem;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            }
        }
        
        /* Loading indicator styles */
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Authentication page styles */
        #auth-wrapper {
            height: 100vh;
            height: 100dvh;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 1.5rem;
            position: absolute;
            top: 0;
            left: 0;
            transition: opacity 0.3s ease;
            display: none; /* Hidden by default */
        }
        
        .auth-card {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }
        
        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        
        .auth-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .auth-form {
            display: none;
        }
        
        .auth-form.active {
            display: block;
        }
        
        .google-signin-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 0.75rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-weight: 500;
            color: #374151;
            transition: all 0.2s;
            margin-top: 1rem;
        }
        
        .google-signin-btn:hover {
            background: #f9fafb;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        }
        
        .divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            color: #6b7280;
        }
        
        .divider::before, .divider::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .divider span {
            padding: 0 1rem;
            font-size: 0.875rem;
        }
        
        /* Auth home button */
        .auth-home-button {
            position: absolute;
            top: 1rem;
            left: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem;
            padding: 0.5rem;
            color: white;
            transition: all 0.2s;
            z-index: 10;
        }
        
        .auth-home-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* Initial message styles */
        .initial-message {
            text-align: center;
            color: #374151;
            padding: 8px 12px;
            font-size: 0.95rem;
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        /* Navigation footer styles - UPDATED to match app background */
        .nav-footer {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 0;
        }
        
        /* Dark mode support for footer */
        @media (prefers-color-scheme: dark) {
            .nav-footer {
                background: #1f2937; /* gray-800 */
                border-top: 1px solid #374151; /* gray-700 */
            }
        }
        
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: #6b7280;
            transition: all 0.2s;
            cursor: pointer;
            flex: 1;
            max-width: 25%;
        }
        
        /* UPDATED: Navigation button active state with transparent background */
        .nav-button.active {
            color: #3b82f6;
            background: rgba(59, 130, 246, 0.1); /* Blue with 10% opacity */
        }
        
        /* UPDATED: Remove white hover effect */
        .nav-button:hover {
            background: rgba(59, 130, 246, 0.05); /* Very subtle hover effect */
        }
        
        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        /* Message input container - UPDATED to match app background */
        #message-input-container {
            display: none;
            padding: 12px 16px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        /* Dark mode support for message input container */
        @media (prefers-color-scheme: dark) {
            #message-input-container {
                background: #1f2937; /* gray-800 */
                border-top: 1px solid #374151; /* gray-700 */
            }
        }
        
        /* Update notification styles */
        .update-notification {
            position: absolute;
            top: 12px;
            right: 12px;
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 20;
            display: none;
        }
        
        .update-date {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 4px;
        }
        
        /* REMOVED: Message status indicator (no longer needed) */
        
        /* Button transition styles */
        .button-transition {
            transition: all 0.2s ease-in-out;
        }

        /* Admin user list styles */
        .user-list-item {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .user-list-item:hover {
            background: #f9fafb;
        }
        
        .user-list-item:last-child {
            border-bottom: none;
        }
        
        .user-name {
            font-weight: 600;
            color: #374151;
        }
        
        .user-email {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .user-last-message {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
        }

        /* Link detection styles - UPDATED for embedded media without message bubble */
        .message-link {
            color: #3b82f6;
            text-decoration: underline;
        }
        
        .embedded-media {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
        }
        
        .embedded-image {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .embedded-video {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* YouTube embed in chat styles */
        .chat-youtube-embed {
            width: 100%;
            margin: 8px 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Course item styles */
        .course-item {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .course-item:hover {
            background: #f9fafb;
        }
        
        .course-item:last-child {
            border-bottom: none;
        }
        
        .course-item-title {
            font-weight: 600;
            color: #374151;
            flex: 1;
        }
        
        .course-item-description {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 4px;
        }
        
        .course-item-arrow {
            color: #9ca3af;
            margin-left: 8px;
        }

        /* Admin course management styles */
        .admin-controls {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .admin-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            border: none;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .edit-btn {
            background: #3b82f6;
            color: white;
        }
        
        .delete-btn {
            background: #ef4444;
            color: white;
        }
        
        .add-btn {
            background: #10b981;
            color: white;
        }
        
        .admin-form {
            background: #f9fafb;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .form-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .save-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .cancel-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>

<body class="h-full bg-gray-100 dark:bg-gray-900 flex items-center justify-center overflow-hidden">

    <!-- Authentication Page (Hidden by default) -->
    <div id="auth-wrapper" class="md:rounded-lg">
        <!-- Home Button on Auth Page -->
        <button id="auth-home-button" class="auth-home-button" aria-label="Go back to main page">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a1.5 1.5 0 0 1 .43 1.069V18a2.25 2.25 0 0 1-2.25 2.25h-5.25a.75.75 0 0 1-.75-.75V15c0-.621-.504-1.125-1.125-1.125h-2.25c-.621 0-1.125.504-1.125 1.125v4.5c0 .414-.336.75-.75.75H3.75A2.25 2.25 0 0 1 1.5 18v-4.401c0-.294.118-.578.325-.785l8.69-8.69Z" />
            </svg>
        </button>
        
        <div class="auth-card">
            <!-- Logo -->
            <div class="text-center mb-6">
                <h1 class="instagram-logo-font text-3xl inline-block bg-yellow-300 dark:bg-yellow-400 text-black dark:text-gray-900 px-4 py-2 rounded-lg">
                    StudentPlus
                </h1>
                <p class="text-gray-600 mt-2">Sign in to access the Solver</p>
            </div>
            
            <!-- Tabs -->
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="signin">Sign In</div>
                <div class="auth-tab" data-tab="signup">Sign Up</div>
            </div>
            
            <!-- Sign In Form -->
            <form id="signin-form" class="auth-form active">
                <div class="space-y-4">
                    <div>
                        <label for="signin-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="signin-email" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="your@email.com"
                        >
                    </div>
                    <div>
                        <label for="signin-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input 
                            type="password" 
                            id="signin-password" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••"
                        >
                    </div>
                    <button 
                        type="submit" 
                        id="signin-button"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors flex items-center justify-center button-transition"
                    >
                        <span id="signin-button-text">Sign In</span>
                        <div id="signin-button-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
                
                <div class="divider">
                    <span>Or continue with</span>
                </div>
                
                <button 
                    type="button" 
                    id="google-signin-button"
                    class="google-signin-btn button-transition"
                >
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                </button>
            </form>
            
            <!-- Sign Up Form -->
            <form id="signup-form" class="auth-form">
                <div class="space-y-4">
                    <div>
                        <label for="signup-name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                        <input 
                            type="text" 
                            id="signup-name" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="John Doe"
                        >
                    </div>
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input 
                            type="email" 
                            id="signup-email" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="your@email.com"
                        >
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input 
                            type="password" 
                            id="signup-password" 
                            required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            placeholder="••••••••"
                        >
                    </div>
                    <button 
                        type="submit" 
                        id="signup-button"
                        class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors flex items-center justify-center button-transition"
                    >
                        <span id="signup-button-text">Create Account</span>
                        <div id="signup-button-spinner" class="loading-spinner ml-2 hidden"></div>
                    </button>
                </div>
                
                <div class="divider">
                    <span>Or continue with</span>
                </div>
                
                <button 
                    type="button" 
                    id="google-signup-button"
                    class="google-signin-btn button-transition"
                >
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Google
                </button>
            </form>
        </div>
    </div>

    <!-- Mobile App Container (Flex Column) -->
    <div id="app-wrapper" class="bg-white dark:bg-gray-800 flex flex-col overflow-hidden rounded-none md:rounded-lg">

        <!-- Header - Fixed at top -->
        <header class="sticky top-0 z-10 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 shadow-sm flex flex-col space-y-3 flex-shrink-0">
            
            <!-- Top Row: Logo and Action Buttons -->
            <div class="flex items-center justify-between w-full">
                <!-- Title (with logo font) -->
                <h1 class="text-xl flex-shrink-0 mr-4">
                    <span class="instagram-logo-font bg-yellow-300 dark:bg-yellow-400 text-black dark:text-gray-900 px-3 py-1 rounded-md">StudentPlus</span>
                </h1>

                <!-- Action Buttons (Right End) -->
                <div class="flex items-center space-x-2 ml-auto">
                    <!-- Home Button -->
                    <button
                        type="button"
                        id="home-button"
                        class="header-action-button p-2 bg-green-500 hover:bg-green-600 text-white shadow-md focus:ring-2 focus:ring-green-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 button-transition"
                        aria-label="Go to Home/Clear Chat"
                    >
                        <!-- Home Icon -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a1.5 1.5 0 0 1 .43 1.069V18a2.25 2.25 0 0 1-2.25 2.25h-5.25a.75.75 0 0 1-.75-.75V15c0-.621-.504-1.125-1.125-1.125h-2.25c-.621 0-1.125.504-1.125 1.125v4.5c0 .414-.336.75-.75.75H3.75A2.25 2.25 0 0 1 1.5 18v-4.401c0-.294.118-.578.325-.785l8.69-8.69Z" />
                        </svg>
                    </button>
                    
                    <!-- Login/Sign Out Button (Conditional) -->
                    <button
                        type="button"
                        id="auth-toggle-button"
                        class="header-action-button p-2 bg-blue-500 hover:bg-blue-600 text-white shadow-md focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 button-transition"
                        aria-label="Sign in or out"
                    >
                        <!-- Default login icon (will be updated based on auth state) -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9A.75.75 0 0 1 15 9V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm5.03 4.72a.75.75 0 0 1 0 1.06l-1.72 1.72h10.94a.75.75 0 0 1 0 1.5H10.81l1.72 1.72a.75.75 0 1 1-1.06 1.06l-3-3a.75.75 0 0 1 0-1.06l3-3a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Bottom Row: Video Code Input -->
            <div class="flex w-full space-x-2">
                <input 
                    type="text" 
                    id="video-code-input"
                    placeholder="Enter video code (e.g., #56788)..."
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400"
                    autocomplete="off"
                >
                <!-- Send Button for Video Code (Blue) - Now uses a simple, robust Send Icon -->
                <button 
                    type="button"
                    id="go-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 flex-shrink-0 flex items-center justify-center button-transition"
                    aria-label="Load video code"
                >
                    <span id="go-button-text" class="flex items-center justify-center">
                        <!-- Simplified Send Icon (Paper Plane) - FIXED PATH -->
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path d="M2.01 21.01L23 12 2.01 3v7l15 2-15 2v7z" />
                        </svg>
                    </span>
                    <div id="go-button-spinner" class="loading-spinner ml-2 hidden"></div>
                </button>
            </div>
        </header>

        <!-- Chat Container - ONLY scrollable area (flex-1 overflow-y-auto) -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6">
            <!-- Initial content will be loaded here dynamically -->
        </main>

        <!-- Update Notification -->
        <div id="update-notification" class="update-notification hidden">
            <div id="notification-text"></div>
            <div id="notification-date" class="update-date"></div>
        </div>

        <!-- Message Input Container -->
        <div id="message-input-container" class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-2 flex-shrink-0">
            <div class="flex w-full space-x-2">
                <input 
                    type="text" 
                    id="message-input"
                    placeholder="Type your message..."
                    class="flex-1 px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-gray-100 dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-blue-500 dark:focus:ring-blue-400"
                    autocomplete="off"
                >
                <button 
                    type="button"
                    id="send-message-button"
                    class="bg-blue-600 hover:bg-blue-700 text-white p-2 rounded-md shadow-sm transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 dark:focus:ring-offset-gray-800 flex-shrink-0 flex items-center justify-center button-transition"
                    aria-label="Send message"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                        <path d="M2.01 21.01L23 12 2.01 3v7l15 2-15 2v7z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Navigation Footer -->
        <footer class="nav-footer">
            <button id="nav-home" class="nav-button active" data-section="home">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="nav-icon">
                    <path d="M11.47 3.84a.75.75 0 0 1 1.06 0l8.69 8.69a1.5 1.5 0 0 1 .43 1.069V18a2.25 2.25 0 0 1-2.25 2.25h-5.25a.75.75 0 0 1-.75-.75V15c0-.621-.504-1.125-1.125-1.125h-2.25c-.621 0-1.125.504-1.125 1.125v4.5c0 .414-.336.75-.75.75H3.75A2.25 2.25 0 0 1 1.5 18v-4.401c0-.294.118-.578.325-.785l8.69-8.69Z" />
                </svg>
                <span class="nav-label">Home</span>
            </button>
            
            <button id="nav-message" class="nav-button" data-section="message">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="nav-icon">
                    <path d="M4.913 2.658c2.075-.27 4.19-.408 6.337-.408 2.147 0 4.262.139 6.337.408 1.922.25 3.291 1.861 3.405 3.727a4.403 4.403 0 0 0-1.032-.211 50.89 50.89 0 0 0-8.42 0c-2.358.196-4.04 2.19-4.04 4.434v4.286a4.47 4.47 0 0 0 2.433 3.984L7.28 21.53A.75.75 0 0 1 6 21v-4.03a48.527 48.527 0 0 1-1.087-.128C2.905 16.58 1.5 14.833 1.5 12.862V6.638c0-1.97 1.405-3.718 3.413-3.979Z" />
                    <path d="M15.75 7.5c-1.376 0-2.739.057-4.086.169C10.124 7.797 9 9.103 9 10.609v4.285c0 1.507 1.128 2.814 2.67 2.94 1.243.102 2.5.157 3.768.165l2.782 2.781a.75.75 0 0 0 1.28-.53v-2.39l.33-.026c1.542-.125 2.67-1.433 2.67-2.94v-4.286c0-1.505-1.125-2.811-2.664-2.94A49.392 49.392 0 0 0 15.75 7.5Z" />
                </svg>
                <span class="nav-label">Message</span>
            </button>
            
            <button id="nav-update" class="nav-button" data-section="update">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="nav-icon">
                    <path fill-rule="evenodd" d="M5.25 9a6.75 6.75 0 0 1 13.5 0v.75c0 2.123.8 4.057 2.118 5.52a.75.75 0 0 1-.297 1.206c-1.544.57-3.16.99-4.831 1.243a3.75 3.75 0 1 1-7.48 0 24.585 24.585 0 0 1-4.831-1.244.75.75 0 0 1-.298-1.205A8.217 8.217 0 0 0 5.25 9.75V9Zm4.502 8.9a2.25 2.25 0 1 0 4.496 0 25.057 25.057 0 0 1-4.496 0Z" clip-rule="evenodd" />
                </svg>
                <span class="nav-label">Update</span>
            </button>
            
            <button id="nav-course" class="nav-button" data-section="course">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="nav-icon">
                    <path d="M11.7 2.805a.75.75 0 0 1 .6 0A60.65 60.65 0 0 1 22.83 8.72a.75.75 0 0 1-.231 1.337 49.949 49.949 0 0 0-9.902 3.912l-.003.002-.34.18a.75.75 0 0 1-.707 0A50.009 50.009 0 0 0 7.5 12.174v-.224c0-.131.067-.248.172-.311a54.614 54.614 0 0 1 4.653-2.52.75.75 0 0 0-.65-1.352 56.129 56.129 0 0 0-4.78 2.589 1.858 1.858 0 0 0-.859 1.228 49.803 49.803 0 0 0-4.634-1.527.75.75 0 0 1-.231-1.337A60.653 60.653 0 0 1 11.7 2.805Z" />
                    <path d="M13.06 15.473a48.45 48.45 0 0 1 7.666-3.282c.134 1.414.22 2.843.255 4.285a.75.75 0 0 1-.46.71 47.878 47.878 0 0 0-8.105 4.342.75.75 0 0 1-.832 0 47.877 47.877 0 0 0-8.104-4.342.75.75 0 0 1-.461-.71c.035-1.442.121-2.87.255-4.286A48.4 48.4 0 0 1 6 13.18v1.27a1.5 1.5 0 0 0-.14 2.508c-.09.38-.222.753-.397 1.11.452.213.901.434 1.346.661a6.729 6.729 0 0 0 .551-1.608 1.5 1.5 0 0 0 .14-2.67v-.645a48.549 48.549 0 0 1 3.44 1.668 2.25 2.25 0 0 0 2.12 0Z" />
                    <path d="M4.462 19.462c.42-.419.753-.89 1-1.394.453.213.902.434 1.347.661a6.743 6.743 0 0 1-1.286 1.794.75.75 0 1 1-1.06-1.06Z" />
                </svg>
                <span class="nav-label">Course</span>
            </button>
        </footer>

        <!-- Error Modal (Kept for static error display) -->
        <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 max-w-sm w-full">
                <h3 class="text-lg font-medium text-red-600 dark:text-red-400">Error</h3>
                <p id="error-message" class="mt-2 text-sm text-gray-700 dark:text-gray-300">
                    An internal error occurred.
                </p>
                <button id="close-error-modal" class="mt-4 w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 button-transition">
                    Close
                </button>
            </div>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // ... All previous code remains the same until the message functions section
            
            // --- Message Functions (UPDATED STRUCTURE) ---
            
            // Load user list for admin - ONLY users who have messaged
            function loadUserList() {
                chatContainer.innerHTML = '<div class="initial-message">Loading users with messages...</div>';
                
                // First, get all users
                db.collection('users').get().then((usersSnapshot) => {
                    const usersWithMessages = [];
                    const promises = [];
                    
                    // Check each user to see if they have messages
                    usersSnapshot.forEach((userDoc) => {
                        const userData = userDoc.data();
                        const promise = db.collection('users').doc(userDoc.id).collection('messages')
                            .limit(1)
                            .get()
                            .then((messagesSnapshot) => {
                                if (!messagesSnapshot.empty) {
                                    usersWithMessages.push({
                                        id: userDoc.id,
                                        data: userData
                                    });
                                }
                            });
                        promises.push(promise);
                    });
                    
                    Promise.all(promises).then(() => {
                        chatContainer.innerHTML = '';
                        
                        if (usersWithMessages.length === 0) {
                            const noUsers = document.createElement('div');
                            noUsers.className = 'initial-message';
                            noUsers.textContent = 'No users have sent messages yet.';
                            chatContainer.appendChild(noUsers);
                            return;
                        }
                        
                        // Sort by last message timestamp if available
                        usersWithMessages.sort((a, b) => {
                            return (b.data.lastMessageTime || 0) - (a.data.lastMessageTime || 0);
                        });
                        
                        usersWithMessages.forEach((user) => {
                            const userElement = document.createElement('div');
                            userElement.className = 'user-list-item';
                            userElement.innerHTML = `
                                <div class="user-name">${user.data.displayName || 'User'}</div>
                                <div class="user-email">${user.data.email}</div>
                            `;
                            
                            userElement.addEventListener('click', () => {
                                selectedUserForAdmin = user.id;
                                loadUserMessages(user.id);
                                messageInputContainer.style.display = 'block';
                            });
                            
                            chatContainer.appendChild(userElement);
                        });
                    });
                }).catch((error) => {
                    console.error("Error loading users:", error);
                    showError("Failed to load users.");
                });
            }
            
            // ... Rest of the previous message functions remain the same
            
            // --- Course Functions ---
            
            // Course navigation state
            let currentCourseLevel = 'subjects';
            let currentSubjectId = null;
            let currentChapterId = null;
            let currentTopicId = null;
            
            // Show course section
            function showCourseSection() {
                // Hide message input
                messageInputContainer.style.display = 'none';
                
                // Clear chat and show course content
                chatContainer.innerHTML = '';
                currentCourseLevel = 'subjects';
                loadSubjects();
            }
            
            // Load subjects
            function loadSubjects() {
                chatContainer.innerHTML = '<div class="initial-message">Loading subjects...</div>';
                
                db.collection('subjects').orderBy('order', 'asc').get().then((querySnapshot) => {
                    chatContainer.innerHTML = '';
                    
                    // Add header
                    const header = document.createElement('div');
                    header.className = 'initial-message';
                    header.textContent = 'Select a Subject';
                    chatContainer.appendChild(header);
                    
                    if (querySnapshot.empty) {
                        const noSubjects = document.createElement('div');
                        noSubjects.className = 'initial-message';
                        noSubjects.textContent = 'No subjects available.';
                        chatContainer.appendChild(noSubjects);
                        
                        // Show admin controls if admin
                        if (isAdmin) {
                            addAdminSubjectControls();
                        }
                        return;
                    }
                    
                    querySnapshot.forEach((doc) => {
                        const subjectData = doc.data();
                        const subjectElement = createCourseItem(
                            subjectData.name,
                            subjectData.description || '',
                            () => {
                                currentSubjectId = doc.id;
                                currentCourseLevel = 'chapters';
                                loadChapters(doc.id, subjectData.name);
                            }
                        );
                        
                        // Add admin controls if admin
                        if (isAdmin) {
                            addAdminControls(subjectElement, 'subject', doc.id, subjectData);
                        }
                        
                        chatContainer.appendChild(subjectElement);
                    });
                    
                    // Add admin controls if admin
                    if (isAdmin) {
                        addAdminSubjectControls();
                    }
                }).catch((error) => {
                    console.error("Error loading subjects:", error);
                    showError("Failed to load subjects.");
                });
            }
            
            // Load chapters for a subject
            function loadChapters(subjectId, subjectName) {
                chatContainer.innerHTML = '<div class="initial-message">Loading chapters...</div>';
                
                db.collection('subjects').doc(subjectId).collection('chapters')
                    .orderBy('order', 'asc')
                    .get()
                    .then((querySnapshot) => {
                        chatContainer.innerHTML = '';
                        
                        // Add header with back button
                        const header = document.createElement('div');
                        header.className = 'flex items-center mb-4';
                        header.innerHTML = `
                            <button id="back-to-subjects" class="mr-2 p-2 rounded-md bg-gray-200 dark:bg-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div>
                                <div class="text-sm text-gray-500">${subjectName}</div>
                                <div class="font-medium">Select a Chapter</div>
                            </div>
                        `;
                        chatContainer.appendChild(header);
                        
                        // Add back button event
                        document.getElementById('back-to-subjects').addEventListener('click', () => {
                            currentCourseLevel = 'subjects';
                            loadSubjects();
                        });
                        
                        if (querySnapshot.empty) {
                            const noChapters = document.createElement('div');
                            noChapters.className = 'initial-message';
                            noChapters.textContent = 'No chapters available for this subject.';
                            chatContainer.appendChild(noChapters);
                            
                            // Show admin controls if admin
                            if (isAdmin) {
                                addAdminChapterControls(subjectId);
                            }
                            return;
                        }
                        
                        querySnapshot.forEach((doc) => {
                            const chapterData = doc.data();
                            const chapterElement = createCourseItem(
                                chapterData.name,
                                chapterData.description || '',
                                () => {
                                    currentChapterId = doc.id;
                                    currentCourseLevel = 'topics';
                                    loadTopics(subjectId, doc.id, chapterData.name);
                                }
                            );
                            
                            // Add admin controls if admin
                            if (isAdmin) {
                                addAdminControls(chapterElement, 'chapter', doc.id, chapterData, subjectId);
                            }
                            
                            chatContainer.appendChild(chapterElement);
                        });
                        
                        // Add admin controls if admin
                        if (isAdmin) {
                            addAdminChapterControls(subjectId);
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading chapters:", error);
                        showError("Failed to load chapters.");
                    });
            }
            
            // Load topics for a chapter
            function loadTopics(subjectId, chapterId, chapterName) {
                chatContainer.innerHTML = '<div class="initial-message">Loading topics...</div>';
                
                db.collection('subjects').doc(subjectId).collection('chapters').doc(chapterId).collection('topics')
                    .orderBy('order', 'asc')
                    .get()
                    .then((querySnapshot) => {
                        chatContainer.innerHTML = '';
                        
                        // Add header with back button
                        const header = document.createElement('div');
                        header.className = 'flex items-center mb-4';
                        header.innerHTML = `
                            <button id="back-to-chapters" class="mr-2 p-2 rounded-md bg-gray-200 dark:bg-gray-700">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                            <div>
                                <div class="text-sm text-gray-500">${chapterName}</div>
                                <div class="font-medium">Select a Topic</div>
                            </div>
                        `;
                        chatContainer.appendChild(header);
                        
                        // Add back button event
                        document.getElementById('back-to-chapters').addEventListener('click', () => {
                            currentCourseLevel = 'chapters';
                            loadChapters(subjectId, '');
                        });
                        
                        if (querySnapshot.empty) {
                            const noTopics = document.createElement('div');
                            noTopics.className = 'initial-message';
                            noTopics.textContent = 'No topics available for this chapter.';
                            chatContainer.appendChild(noTopics);
                            
                            // Show admin controls if admin
                            if (isAdmin) {
                                addAdminTopicControls(subjectId, chapterId);
                            }
                            return;
                        }
                        
                        querySnapshot.forEach((doc) => {
                            const topicData = doc.data();
                            const topicElement = createCourseItem(
                                topicData.name,
                                topicData.description || '',
                                () => {
                                    currentTopicId = doc.id;
                                    loadTopicContent(subjectId, chapterId, doc.id, topicData);
                                }
                            );
                            
                            // Add admin controls if admin
                            if (isAdmin) {
                                addAdminControls(topicElement, 'topic', doc.id, topicData, subjectId, chapterId);
                            }
                            
                            chatContainer.appendChild(topicElement);
                        });
                        
                        // Add admin controls if admin
                        if (isAdmin) {
                            addAdminTopicControls(subjectId, chapterId);
                        }
                    })
                    .catch((error) => {
                        console.error("Error loading topics:", error);
                        showError("Failed to load topics.");
                    });
            }
            
            // Load topic content (videos and images)
            function loadTopicContent(subjectId, chapterId, topicId, topicData) {
                chatContainer.innerHTML = '<div class="initial-message">Loading content...</div>';
                
                // Add header with back button
                const header = document.createElement('div');
                header.className = 'flex items-center mb-4';
                header.innerHTML = `
                    <button id="back-to-topics" class="mr-2 p-2 rounded-md bg-gray-200 dark:bg-gray-700">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <div class="font-medium">${topicData.name}</div>
                `;
                chatContainer.appendChild(header);
                
                // Add back button event
                document.getElementById('back-to-topics').addEventListener('click', () => {
                    currentCourseLevel = 'topics';
                    loadTopics(subjectId, chapterId, '');
                });
                
                // Check if topic has video code or direct video URLs
                if (topicData.videoCode) {
                    // Use video code to fetch content
                    fetchVideoData(topicData.videoCode).then((videoData) => {
                        if (videoData) {
                            // Process multiple videos
                            let foundVideos = false;
                            
                            for (let i = 1; i <= 10; i++) {
                                const videoUrl = videoData[`VideoURL${i}`];
                                const description = videoData[`Description${i}`];
                                
                                if (videoUrl) {
                                    // Collect all image URLs for this video
                                    const imageUrls = [];
                                    for (let j = 1; j <= 10; j++) {
                                        const imageUrl = videoData[`ImageURL${i}_${j}`];
                                        if (imageUrl) {
                                            imageUrls.push(imageUrl);
                                        } else {
                                            break;
                                        }
                                    }
                                    
                                    addVideoPlayerInChat(videoUrl, description, imageUrls);
                                    foundVideos = true;
                                } else {
                                    break;
                                }
                            }
                            
                            if (!foundVideos) {
                                const noContent = document.createElement('div');
                                noContent.className = 'initial-message';
                                noContent.textContent = 'No video content available for this topic.';
                                chatContainer.appendChild(noContent);
                            }
                        } else {
                            const noContent = document.createElement('div');
                            noContent.className = 'initial-message';
                            noContent.textContent = 'No video content available for this topic.';
                            chatContainer.appendChild(noContent);
                        }
                    }).catch((error) => {
                        console.error("Error loading topic content:", error);
                        const errorMsg = document.createElement('div');
                        errorMsg.className = 'initial-message';
                        errorMsg.textContent = 'Error loading topic content.';
                        chatContainer.appendChild(errorMsg);
                    });
                } else if (topicData.videoUrl) {
                    // Use direct video URL
                    const imageUrls = topicData.imageUrls || [];
                    addVideoPlayerInChat(topicData.videoUrl, topicData.description, imageUrls);
                } else {
                    const noContent = document.createElement('div');
                    noContent.className = 'initial-message';
                    noContent.textContent = 'No content available for this topic.';
                    chatContainer.appendChild(noContent);
                }
                
                // Add admin controls if admin
                if (isAdmin) {
                    addAdminTopicContentControls(subjectId, chapterId, topicId, topicData);
                }
            }
            
            // Create course item element
            function createCourseItem(title, description, clickHandler) {
                const item = document.createElement('div');
                item.className = 'course-item';
                item.innerHTML = `
                    <div class="flex-1">
                        <div class="course-item-title">${title}</div>
                        ${description ? `<div class="course-item-description">${description}</div>` : ''}
                    </div>
                    <div class="course-item-arrow">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M16.28 11.47a.75.75 0 0 1 0 1.06l-7.5 7.5a.75.75 0 0 1-1.06-1.06L14.69 12 7.72 5.03a.75.75 0 0 1 1.06-1.06l7.5 7.5Z" clip-rule="evenodd" />
                        </svg>
                    </div>
                `;
                
                item.addEventListener('click', clickHandler);
                return item;
            }
            
            // --- Admin Course Management Functions ---
            
            // Add admin controls to course items
            function addAdminControls(element, type, id, data, parentId = null, grandParentId = null) {
                const controls = document.createElement('div');
                controls.className = 'admin-controls';
                
                controls.innerHTML = `
                    <button class="admin-btn edit-btn" data-type="${type}" data-id="${id}">Edit</button>
                    <button class="admin-btn delete-btn" data-type="${type}" data-id="${id}">Delete</button>
                `;
                
                element.appendChild(controls);
                
                // Add edit event
                controls.querySelector('.edit-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    showEditForm(type, id, data, parentId, grandParentId);
                });
                
                // Add delete event
                controls.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteCourseItem(type, id, parentId, grandParentId);
                });
            }
            
            // Add admin subject controls
            function addAdminSubjectControls() {
                const addButton = document.createElement('button');
                addButton.className = 'w-full mt-4 p-3 bg-green-600 text-white rounded-md admin-btn add-btn';
                addButton.textContent = 'Add New Subject';
                addButton.addEventListener('click', () => {
                    showAddForm('subject');
                });
                chatContainer.appendChild(addButton);
            }
            
            // Add admin chapter controls
            function addAdminChapterControls(subjectId) {
                const addButton = document.createElement('button');
                addButton.className = 'w-full mt-4 p-3 bg-green-600 text-white rounded-md admin-btn add-btn';
                addButton.textContent = 'Add New Chapter';
                addButton.addEventListener('click', () => {
                    showAddForm('chapter', subjectId);
                });
                chatContainer.appendChild(addButton);
            }
            
            // Add admin topic controls
            function addAdminTopicControls(subjectId, chapterId) {
                const addButton = document.createElement('button');
                addButton.className = 'w-full mt-4 p-3 bg-green-600 text-white rounded-md admin-btn add-btn';
                addButton.textContent = 'Add New Topic';
                addButton.addEventListener('click', () => {
                    showAddForm('topic', subjectId, chapterId);
                });
                chatContainer.appendChild(addButton);
            }
            
            // Add admin topic content controls
            function addAdminTopicContentControls(subjectId, chapterId, topicId, topicData) {
                const editButton = document.createElement('button');
                editButton.className = 'w-full mt-4 p-3 bg-blue-600 text-white rounded-md admin-btn edit-btn';
                editButton.textContent = 'Edit Topic Content';
                editButton.addEventListener('click', () => {
                    showEditForm('topic', topicId, topicData, subjectId, chapterId);
                });
                chatContainer.appendChild(editButton);
            }
            
            // Show add form
            function showAddForm(type, parentId = null, grandParentId = null) {
                const form = document.createElement('div');
                form.className = 'admin-form';
                
                let formHTML = '';
                let formTitle = '';
                
                switch (type) {
                    case 'subject':
                        formTitle = 'Add New Subject';
                        formHTML = `
                            <div class="form-group">
                                <label>Subject Name</label>
                                <input type="text" class="form-input" id="subject-name">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="subject-description"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="subject-order" value="0">
                            </div>
                        `;
                        break;
                    case 'chapter':
                        formTitle = 'Add New Chapter';
                        formHTML = `
                            <div class="form-group">
                                <label>Chapter Name</label>
                                <input type="text" class="form-input" id="chapter-name">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="chapter-description"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="chapter-order" value="0">
                            </div>
                        `;
                        break;
                    case 'topic':
                        formTitle = 'Add New Topic';
                        formHTML = `
                            <div class="form-group">
                                <label>Topic Name</label>
                                <input type="text" class="form-input" id="topic-name">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="topic-description"></textarea>
                            </div>
                            <div class="form-group">
                                <label>Video Code (optional)</label>
                                <input type="text" class="form-input" id="topic-video-code" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label>Or Direct Video URL (optional)</label>
                                <input type="text" class="form-input" id="topic-video-url" placeholder="https://youtube.com/embed/...">
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="topic-order" value="0">
                            </div>
                        `;
                        break;
                }
                
                form.innerHTML = `
                    <h3 class="font-medium mb-4">${formTitle}</h3>
                    ${formHTML}
                    <div class="form-actions">
                        <button class="save-btn" id="save-${type}">Save</button>
                        <button class="cancel-btn" id="cancel-${type}">Cancel</button>
                    </div>
                `;
                
                chatContainer.appendChild(form);
                
                // Add save event
                document.getElementById(`save-${type}`).addEventListener('click', () => {
                    saveCourseItem(type, null, parentId, grandParentId);
                });
                
                // Add cancel event
                document.getElementById(`cancel-${type}`).addEventListener('click', () => {
                    form.remove();
                });
            }
            
            // Show edit form
            function showEditForm(type, id, data, parentId = null, grandParentId = null) {
                const form = document.createElement('div');
                form.className = 'admin-form';
                
                let formHTML = '';
                let formTitle = '';
                
                switch (type) {
                    case 'subject':
                        formTitle = 'Edit Subject';
                        formHTML = `
                            <div class="form-group">
                                <label>Subject Name</label>
                                <input type="text" class="form-input" id="subject-name" value="${data.name || ''}">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="subject-description">${data.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="subject-order" value="${data.order || 0}">
                            </div>
                        `;
                        break;
                    case 'chapter':
                        formTitle = 'Edit Chapter';
                        formHTML = `
                            <div class="form-group">
                                <label>Chapter Name</label>
                                <input type="text" class="form-input" id="chapter-name" value="${data.name || ''}">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="chapter-description">${data.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="chapter-order" value="${data.order || 0}">
                            </div>
                        `;
                        break;
                    case 'topic':
                        formTitle = 'Edit Topic';
                        formHTML = `
                            <div class="form-group">
                                <label>Topic Name</label>
                                <input type="text" class="form-input" id="topic-name" value="${data.name || ''}">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-input" id="topic-description">${data.description || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Video Code (optional)</label>
                                <input type="text" class="form-input" id="topic-video-code" value="${data.videoCode || ''}" placeholder="e.g., 12345">
                            </div>
                            <div class="form-group">
                                <label>Or Direct Video URL (optional)</label>
                                <input type="text" class="form-input" id="topic-video-url" value="${data.videoUrl || ''}" placeholder="https://youtube.com/embed/...">
                            </div>
                            <div class="form-group">
                                <label>Order</label>
                                <input type="number" class="form-input" id="topic-order" value="${data.order || 0}">
                            </div>
                        `;
                        break;
                }
                
                form.innerHTML = `
                    <h3 class="font-medium mb-4">${formTitle}</h3>
                    ${formHTML}
                    <div class="form-actions">
                        <button class="save-btn" id="save-${type}">Save</button>
                        <button class="cancel-btn" id="cancel-${type}">Cancel</button>
                    </div>
                `;
                
                chatContainer.appendChild(form);
                
                // Add save event
                document.getElementById(`save-${type}`).addEventListener('click', () => {
                    saveCourseItem(type, id, parentId, grandParentId);
                });
                
                // Add cancel event
                document.getElementById(`cancel-${type}`).addEventListener('click', () => {
                    form.remove();
                });
            }
            
            // Save course item
            function saveCourseItem(type, id, parentId = null, grandParentId = null) {
                let data = {};
                let collectionRef;
                
                switch (type) {
                    case 'subject':
                        data = {
                            name: document.getElementById('subject-name').value,
                            description: document.getElementById('subject-description').value,
                            order: parseInt(document.getElementById('subject-order').value) || 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        collectionRef = db.collection('subjects');
                        break;
                    case 'chapter':
                        data = {
                            name: document.getElementById('chapter-name').value,
                            description: document.getElementById('chapter-description').value,
                            order: parseInt(document.getElementById('chapter-order').value) || 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        collectionRef = db.collection('subjects').doc(parentId).collection('chapters');
                        break;
                    case 'topic':
                        data = {
                            name: document.getElementById('topic-name').value,
                            description: document.getElementById('topic-description').value,
                            order: parseInt(document.getElementById('topic-order').value) || 0,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Add video code or URL if provided
                        const videoCode = document.getElementById('topic-video-code').value;
                        const videoUrl = document.getElementById('topic-video-url').value;
                        
                        if (videoCode) {
                            data.videoCode = videoCode;
                        } else if (videoUrl) {
                            data.videoUrl = videoUrl;
                        }
                        
                        collectionRef = db.collection('subjects').doc(parentId).collection('chapters').doc(grandParentId).collection('topics');
                        break;
                }
                
                // Add createdAt for new items
                if (!id) {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                }
                
                const promise = id ? collectionRef.doc(id).update(data) : collectionRef.add(data);
                
                promise.then(() => {
                    // Reload the current view
                    switch (currentCourseLevel) {
                        case 'subjects':
                            loadSubjects();
                            break;
                        case 'chapters':
                            loadChapters(currentSubjectId, '');
                            break;
                        case 'topics':
                            loadTopics(currentSubjectId, currentChapterId, '');
                            break;
                    }
                }).catch((error) => {
                    console.error(`Error saving ${type}:`, error);
                    showError(`Failed to save ${type}.`);
                });
            }
            
            // Delete course item
            function deleteCourseItem(type, id, parentId = null, grandParentId = null) {
                if (!confirm(`Are you sure you want to delete this ${type}?`)) {
                    return;
                }
                
                let collectionRef;
                
                switch (type) {
                    case 'subject':
                        collectionRef = db.collection('subjects').doc(id);
                        break;
                    case 'chapter':
                        collectionRef = db.collection('subjects').doc(parentId).collection('chapters').doc(id);
                        break;
                    case 'topic':
                        collectionRef = db.collection('subjects').doc(parentId).collection('chapters').doc(grandParentId).collection('topics').doc(id);
                        break;
                }
                
                collectionRef.delete().then(() => {
                    // Reload the current view
                    switch (currentCourseLevel) {
                        case 'subjects':
                            loadSubjects();
                            break;
                        case 'chapters':
                            loadChapters(currentSubjectId, '');
                            break;
                        case 'topics':
                            loadTopics(currentSubjectId, currentChapterId, '');
                            break;
                    }
                }).catch((error) => {
                    console.error(`Error deleting ${type}:`, error);
                    showError(`Failed to delete ${type}.`);
                });
            }
            
            // ... Rest of the previous code remains the same
            
            // Update the switchSection function to include course section
            function switchSection(section) {
                // Update active nav button
                navButtons.forEach(button => {
                    button.classList.remove('active');
                });
                document.querySelector(`[data-section="${section}"]`).classList.add('active');
                
                // Update current section
                currentSection = section;
                
                // Handle section-specific logic
                switch(section) {
                    case 'home':
                        showHomeSection();
                        break;
                    case 'message':
                        showMessageSection();
                        break;
                    case 'update':
                        showUpdateSection();
                        break;
                    case 'course':
                        showCourseSection();
                        break;
                }
            }
            
            // Initialize the app
            initializeNavigation();
            
            // ... Rest of the initialization code remains the same
        });
    </script>
</body>
</html>
