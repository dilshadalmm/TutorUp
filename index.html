<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <title>ConceptBlitz - Chapter Based Learning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- KaTeX for LaTeX Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
            font-family: 'Inter', sans-serif;
        }

        /* App container */
        #app-wrapper {
            height: 100dvh;
            width: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: #f8fafc;
            overflow: hidden;
        }

        /* Header styles */
        .app-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .back-button {
            background: none;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            color: #4b5563;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        /* Content container */
        .content-container {
            height: calc(100dvh - 64px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Page 1: Home Page */
        .subject-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        .chapters-list {
            padding: 1rem;
        }

        .chapter-card {
            width: 98%;
            margin: 0.75rem auto;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .chapter-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .chapter-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        /* Auth buttons container */
        .auth-buttons-container {
            width: 98%;
            margin: 1rem auto;
            background: #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .auth-button {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .auth-button.login {
            background: white;
            color: #3b82f6;
        }

        .auth-button.logout {
            background: #ef4444;
            color: white;
        }

        .auth-button.register {
            background: #10b981;
            color: white;
        }

        /* Page 2: Chapter Page */
        .categories-list {
            padding: 1rem;
        }

        .category-card {
            width: 98%;
            margin: 0.75rem auto;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .category-card:hover {
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .category-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        /* Page 3: Questions Page */
        .questions-list {
            padding: 1rem;
        }

        .category-header {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #3b82f6;
        }

        .question-card {
            width: 100%;
            margin-bottom: 1.5rem;
            background: white;
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e5e7eb;
        }

        .question-text {
            font-size: 1rem;
            color: #374151;
            line-height: 1.6;
            margin-bottom: 1rem;
            white-space: pre-wrap;
        }

        .options-container {
            margin: 1rem 0;
        }

        .option-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-item:hover {
            background: #f3f4f6;
        }

        .option-marker {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 0.75rem;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .option-text {
            flex: 1;
            color: #374151;
        }

        .submit-button {
            width: 100%;
            padding: 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 1rem;
        }

        .submit-button:hover {
            background: #2563eb;
        }

        .submit-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .explanation-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            display: none;
        }

        .explanation-section.show {
            display: block;
        }

        .explanation-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .explanation-text {
            color: #4b5563;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        /* Loading states */
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Error message */
        .error-message {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem;
            text-align: center;
        }

        /* Auth modal */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-modal.show {
            display: flex;
        }

        .auth-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .auth-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-form input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Inter', sans-serif;
        }

        .auth-form button {
            width: 100%;
            padding: 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            #app-wrapper {
                max-width: 768px;
                margin: 0 auto;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>

<body>
    <div id="app-wrapper">
        <!-- App Header -->
        <header class="app-header" id="app-header" style="display: none;">
            <button class="back-button" id="back-button">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
            </button>
            <div class="header-title" id="header-title"></div>
        </header>

        <!-- Main Content -->
        <main class="content-container" id="content-container">
            <!-- Pages will be loaded here -->
        </main>

        <!-- Auth Modal -->
        <div class="auth-modal" id="auth-modal">
            <div class="auth-card">
                <div class="auth-tabs">
                    <div class="auth-tab active" data-tab="login">Login</div>
                    <div class="auth-tab" data-tab="register">Register</div>
                </div>

                <form id="login-form" class="auth-form active">
                    <input type="email" id="login-email" placeholder="Email" required>
                    <input type="password" id="login-password" placeholder="Password" required>
                    <button type="submit">Login</button>
                </form>

                <form id="register-form" class="auth-form">
                    <input type="text" id="register-name" placeholder="Full Name" required>
                    <input type="email" id="register-email" placeholder="Email" required>
                    <input type="password" id="register-password" placeholder="Password" required>
                    <button type="submit">Register</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
            authDomain: "geobazarr.firebaseapp.com",
            databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
            projectId: "geobazarr",
            storageBucket: "geobazarr.firebasestorage.app",
            messagingSenderId: "679949247383",
            appId: "1:679949247383:web:036d4f32038422ebb89ad2"
        };

        // Initialize Firebase
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // App State
        let currentSubject = "Mathematics"; // Default subject name
        let currentPage = 'home'; // 'home', 'chapter', 'questions'
        let currentChapter = null;
        let currentCategory = null;
        let currentUser = null;

        // DOM Elements
        const appHeader = document.getElementById('app-header');
        const headerTitle = document.getElementById('header-title');
        const backButton = document.getElementById('back-button');
        const contentContainer = document.getElementById('content-container');
        const authModal = document.getElementById('auth-modal');

        // Initialize the app
        function initApp() {
            showHomePage();
            setupEventListeners();
            setupAuthStateListener();
        }

        // Setup event listeners
        function setupEventListeners() {
            backButton.addEventListener('click', handleBack);
            
            // Auth tab switching
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.dataset.tab;
                    switchAuthTab(tabName);
                });
            });
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Register form
            document.getElementById('register-form').addEventListener('submit', handleRegister);
        }

        // Setup auth state listener
        function setupAuthStateListener() {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateAuthButtons();
            });
        }

        // Switch auth tab
        function switchAuthTab(tabName) {
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });
            
            document.querySelectorAll('.auth-form').forEach(form => {
                form.classList.toggle('active', form.id === `${tabName}-form`);
            });
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                authModal.classList.remove('show');
                showHomePage();
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        // Handle register
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({
                    displayName: name
                });
                
                authModal.classList.remove('show');
                showHomePage();
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                showHomePage();
            } catch (error) {
                alert('Logout failed: ' + error.message);
            }
        }

        // Update auth buttons based on user state
        function updateAuthButtons() {
            const authButtonsHTML = currentUser ? `
                <button class="auth-button logout" onclick="handleLogout()">Logout</button>
            ` : `
                <button class="auth-button login" onclick="authModal.classList.add('show')">Login</button>
                <button class="auth-button register" onclick="switchAuthTab('register'); authModal.classList.add('show')">Register</button>
            `;
            
            // Update auth buttons on home page
            if (currentPage === 'home') {
                const authContainer = contentContainer.querySelector('.auth-buttons-container');
                if (authContainer) {
                    authContainer.innerHTML = authButtonsHTML;
                }
            }
        }

        // Handle back navigation
        function handleBack() {
            if (currentPage === 'questions') {
                showChapterPage(currentChapter);
            } else if (currentPage === 'chapter') {
                showHomePage();
            }
        }

        // Show home page
        async function showHomePage() {
            currentPage = 'home';
            currentChapter = null;
            currentCategory = null;
            
            // Hide header back button
            appHeader.style.display = 'flex';
            backButton.style.display = 'none';
            headerTitle.textContent = 'ConceptBlitz';
            
            // Show loading
            contentContainer.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                // Fetch subject image
                const subjectDoc = await db.collection('subjects').doc(currentSubject).get();
                const subjectData = subjectDoc.data();
                
                // Fetch chapters
                const chaptersSnapshot = await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').get();
                
                // Build home page HTML
                let html = '';
                
                // Subject image
                if (subjectData?.imageUrl) {
                    html += `<img src="${subjectData.imageUrl}" alt="${currentSubject}" class="subject-image" onerror="this.style.display='none'">`;
                }
                
                // Chapters list
                html += '<div class="chapters-list">';
                
                if (chaptersSnapshot.empty) {
                    html += '<div class="error-message">No chapters available</div>';
                } else {
                    chaptersSnapshot.forEach(doc => {
                        const chapter = doc.data();
                        html += `
                            <div class="chapter-card" onclick="showChapterPage('${doc.id}')">
                                <h3 class="chapter-title">${chapter.name || doc.id}</h3>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                
                // Auth buttons container (scrollable, not fixed)
                html += `
                    <div class="auth-buttons-container">
                        ${currentUser ? 
                            `<button class="auth-button logout" onclick="handleLogout()">Logout</button>` :
                            `<button class="auth-button login" onclick="authModal.classList.add('show')">Login</button>
                             <button class="auth-button register" onclick="switchAuthTab('register'); authModal.classList.add('show')">Register</button>`
                        }
                    </div>
                `;
                
                contentContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading home page:', error);
                contentContainer.innerHTML = '<div class="error-message">Failed to load content</div>';
            }
        }

        // Show chapter page
        async function showChapterPage(chapterName) {
            currentPage = 'chapter';
            currentChapter = chapterName;
            currentCategory = null;
            
            // Show header with back button
            appHeader.style.display = 'flex';
            backButton.style.display = 'flex';
            headerTitle.textContent = chapterName;
            
            // Show loading
            contentContainer.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                // Fetch categories
                const categoriesSnapshot = await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(chapterName)
                    .collection('categories').get();
                
                // Build chapter page HTML
                let html = '<div class="categories-list">';
                
                if (categoriesSnapshot.empty) {
                    html += '<div class="error-message">No categories available</div>';
                } else {
                    categoriesSnapshot.forEach(doc => {
                        const category = doc.data();
                        html += `
                            <div class="category-card" onclick="showQuestionsPage('${chapterName}', '${doc.id}')">
                                <h3 class="category-title">${category.name || doc.id}</h3>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                contentContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading chapter page:', error);
                contentContainer.innerHTML = '<div class="error-message">Failed to load categories</div>';
            }
        }

        // Show questions page
        async function showQuestionsPage(chapterName, categoryName) {
            currentPage = 'questions';
            currentChapter = chapterName;
            currentCategory = categoryName;
            
            // Show header with back button
            appHeader.style.display = 'flex';
            backButton.style.display = 'flex';
            headerTitle.textContent = chapterName;
            
            // Show loading
            contentContainer.innerHTML = '<div class="loading-spinner"></div>';
            
            try {
                // Fetch category data for title
                const categoryDoc = await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(chapterName)
                    .collection('categories').doc(categoryName).get();
                
                const categoryData = categoryDoc.data();
                
                // Fetch questions
                const questionsSnapshot = await db.collection('subjects').doc(currentSubject)
                    .collection('chapters').doc(chapterName)
                    .collection('categories').doc(categoryName)
                    .collection('questions').get();
                
                // Build questions page HTML
                let html = '<div class="questions-list">';
                
                // Category title (center aligned)
                html += `<h2 class="category-header">${categoryData?.name || categoryName}</h2>`;
                
                if (questionsSnapshot.empty) {
                    html += '<div class="error-message">No questions available</div>';
                } else {
                    questionsSnapshot.forEach((doc, index) => {
                        const question = doc.data();
                        const questionId = doc.id;
                        
                        html += `
                            <div class="question-card" data-question-id="${questionId}">
                                <div class="question-text">${(question.questionText || '')
                                    .replace(/\n/g, '<br>')
                                    .replace(/\\n/g, '<br>')}</div>
                                
                                <div class="options-container">
                                    ${question.options?.map((option, idx) => `
                                        <div class="option-item" onclick="selectOption(this, ${idx})">
                                            <div class="option-marker">${String.fromCharCode(65 + idx)}</div>
                                            <div class="option-text">${option}</div>
                                        </div>
                                    `).join('') || ''}
                                </div>
                                
                                <button class="submit-button" onclick="submitAnswer(this)" disabled>Submit Answer</button>
                                
                                <div class="explanation-section">
                                    <div class="explanation-title">Explanation</div>
                                    <div class="explanation-text">${(question.explanation || '')
                                        .replace(/\n/g, '<br>')
                                        .replace(/\\n/g, '<br>')}</div>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += '</div>';
                contentContainer.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading questions page:', error);
                contentContainer.innerHTML = '<div class="error-message">Failed to load questions</div>';
            }
        }

        // Select option in question
        function selectOption(optionElement, optionIndex) {
            const questionCard = optionElement.closest('.question-card');
            
            // Remove selected class from all options
            questionCard.querySelectorAll('.option-item').forEach(item => {
                item.classList.remove('selected');
                item.style.background = '#f9fafb';
            });
            
            // Add selected class to clicked option
            optionElement.classList.add('selected');
            optionElement.style.background = '#e0e7ff';
            
            // Enable submit button
            questionCard.querySelector('.submit-button').disabled = false;
            
            // Store selected option
            optionElement.closest('.question-card').dataset.selectedOption = optionIndex;
        }

        // Submit answer
        function submitAnswer(button) {
            const questionCard = button.closest('.question-card');
            const selectedOption = parseInt(questionCard.dataset.selectedOption);
            const correctOption = parseInt(questionCard.dataset.correctOption) || 0;
            
            // Disable all options
            questionCard.querySelectorAll('.option-item').forEach(item => {
                item.style.pointerEvents = 'none';
            });
            
            // Show correct/incorrect
            questionCard.querySelectorAll('.option-item').forEach((item, index) => {
                const marker = item.querySelector('.option-marker');
                if (index === correctOption) {
                    marker.style.background = '#10b981';
                    marker.style.color = 'white';
                } else if (index === selectedOption && index !== correctOption) {
                    marker.style.background = '#ef4444';
                    marker.style.color = 'white';
                }
            });
            
            // Show explanation
            questionCard.querySelector('.explanation-section').classList.add('show');
            
            // Disable submit button
            button.disabled = true;
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
