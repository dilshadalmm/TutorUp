<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <title>ConceptBlitz - Chapter Based Learning</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Anton for brand and Merriweather for body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&display=swap" rel="stylesheet">
    
    <!-- KaTeX for LaTeX Rendering -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/mhchem.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* CRITICAL: Ensure HTML and BODY are full height and non-scrollable */
        html {
            height: 100%;
            overflow: hidden !important;
        }

        /* Use the Merriweather font family as default */
        body {
            font-family: 'Merriweather', serif;
            font-optical-sizing: auto;
            font-weight: 400;
            font-style: normal;
            font-variation-settings: "wdth" 100;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* Light mode: Black text */
            color: #000000;
            
            /* CRITICAL: Prevent the main body from scrolling at all */
            overflow: hidden !important; 
            
            user-select: none;
            -webkit-user-select: none; 
            -moz-user-select: none;
            -ms-user-select: none; 
            
            /* Prevents elastic scrolling on iOS */
            overscroll-behavior: none;
            
            /* Make body a fixed container occupying full screen */
            position: fixed;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* Dark mode: White text */
        body.dark {
            color: #ffffff;
            background-color: #1a1a1a;
        }

        /* App wrapper - uses dynamic viewport height for mobile keyboard stability */
        #app-wrapper {
            height: 100vh; /* Fallback */
            height: 100dvh; /* Dynamic viewport height (best for mobile keyboard) */
            width: 100%;
            position: absolute; /* Relative to fixed body */
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden; /* Ensures only the chat container can scroll */
            background-color: #ffffff;
        }

        .dark #app-wrapper {
            background-color: #1a1a1a;
        }
        
        /* NEW: Brand font colors */
        .concept-text {
            color: #1a1a1a; /* Black for light mode */
        }
        
        .blitz-text {
            color: #3b82f6; /* Blue */
        }
        
        .dark .concept-text {
            color: #ffffff; /* White for dark mode */
        }
        
        .dark .blitz-text {
            color: #60a5fa; /* Lighter blue for dark mode */
        }

        /* Style for the ConceptBlitz logo font - USING ANTON */
        .conceptblitz-logo {
            font-family: 'Anton', sans-serif;
            font-weight: 400;
            font-style: normal;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        /* ===== SPLASH SCREEN STYLES ===== */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }

        #splash-screen.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #splash-screen.hidden {
            display: none;
        }

        .splash-logo {
            max-width: 90%;
            max-height: 90%;
            width: auto;
            height: auto;
            object-fit: contain;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        /* ===== HEADER STYLES ===== */
        .app-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .dark .app-header {
            background: #1a1a1a;
            border-bottom-color: #374151;
        }

        .header-title {
            font-family: 'Anton', sans-serif;
            font-size: 1.5rem;
            font-weight: 400;
            letter-spacing: -0.5px;
            text-transform: uppercase;
            text-align: center;
            flex: 1;
        }

        /* ===== CONTENT CONTAINER STYLES ===== */
        #content-container {
            height: calc(100% - 4rem); /* Subtract header height */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            background-color: #f9fafb;
        }

        .dark #content-container {
            background-color: #111827;
        }

        /* ===== PAGE 1: HOME PAGE STYLES ===== */
        .subject-image {
            width: 100%;
            height: auto;
            display: block;
            object-fit: cover;
        }

        .chapters-list {
            padding: 1rem 1%;
            width: 100%;
        }

        .chapter-item {
            width: 98%;
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dark .chapter-item {
            background: #1f2937;
            border-color: #374151;
        }

        .chapter-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .chapter-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
            line-height: 1.4;
            text-align: left;
        }

        .dark .chapter-title {
            color: #f9fafb;
        }

        /* Auth buttons container at bottom */
        .auth-buttons-container {
            width: 98%;
            margin: 2rem auto;
            padding: 1.5rem;
            background: #3b82f6;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .dark .auth-buttons-container {
            background: #1e40af;
        }

        .auth-button {
            width: 100%;
            padding: 0.875rem;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Merriweather', serif;
        }

        .login-button {
            background: white;
            color: #3b82f6;
        }

        .dark .login-button {
            background: #f9fafb;
            color: #1e40af;
        }

        .logout-button {
            background: #ef4444;
            color: white;
        }

        .dark .logout-button {
            background: #dc2626;
        }

        .register-button {
            background: #10b981;
            color: white;
        }

        .dark .register-button {
            background: #059669;
        }

        /* ===== PAGE 2: CHAPTER PAGE STYLES ===== */
        .categories-list {
            padding: 1rem 1%;
            width: 100%;
        }

        .category-item {
            width: 98%;
            background: white;
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dark .category-item {
            background: #1f2937;
            border-color: #374151;
        }

        .category-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .category-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 1.125rem;
            line-height: 1.4;
            text-align: left;
        }

        .dark .category-title {
            color: #f9fafb;
        }

        /* ===== PAGE 3: QUESTIONS PAGE STYLES ===== */
        .category-header {
            width: 100%;
            padding: 2rem 1%;
            text-align: center;
            background: linear-gradient(to right, #3b82f6, #1d4ed8);
            color: white;
        }

        .dark .category-header {
            background: linear-gradient(to right, #1e40af, #1e3a8a);
        }

        .category-name {
            font-size: 1.75rem;
            font-weight: 700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .questions-list {
            padding: 1rem 1%;
            width: 100%;
        }

        .question-item {
            width: 100%;
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .dark .question-item {
            background: #1f2937;
            border-color: #374151;
        }

        .question-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            text-align: left;
            white-space: pre-wrap;
        }

        .dark .question-text {
            color: #f9fafb;
        }

        .options-container {
            width: 100%;
            margin: 1.5rem 0;
        }

        .option-item {
            width: 100%;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            text-align: left;
            font-family: 'Merriweather', serif;
            font-size: 1rem;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .dark .option-item {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .option-item:hover {
            background: #f9fafb;
            border-color: #3b82f6;
        }

        .dark .option-item:hover {
            background: #4b5563;
        }

        .option-item.selected {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .dark .option-item.selected {
            background: #1e40af;
            border-color: #3b82f6;
            color: #f9fafb;
        }

        .option-item.correct {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .dark .option-item.correct {
            background: #064e3b;
            border-color: #10b981;
            color: #a7f3d0;
        }

        .option-item.incorrect {
            background: #fee2e2;
            border-color: #ef4444;
            color: #7f1d1d;
        }

        .dark .option-item.incorrect {
            background: #7f1d1d;
            border-color: #ef4444;
            color: #fecaca;
        }

        .option-marker {
            width: 24px;
            height: 24px;
            border: 2px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .dark .option-marker {
            border-color: #6b7280;
        }

        .option-item.selected .option-marker {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .option-text {
            flex: 1;
            line-height: 1.5;
            text-align: left;
        }

        .submit-button {
            width: 100%;
            padding: 1rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 1rem;
            font-family: 'Merriweather', serif;
        }

        .submit-button:hover:not(:disabled) {
            background: #d97706;
        }

        .submit-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        .explanation-section {
            width: 100%;
            padding: 1.5rem;
            margin-top: 1.5rem;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            display: none;
            text-align: left;
        }

        .dark .explanation-section {
            background: #374151;
            border-color: #4b5563;
        }

        .explanation-section.show {
            display: block;
        }

        .explanation-title {
            font-weight: 700;
            color: #1f2937;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            text-align: left;
        }

        .dark .explanation-title {
            color: #f9fafb;
        }

        .explanation-text {
            color: #4b5563;
            line-height: 1.6;
            margin-bottom: 1rem;
            text-align: left;
            white-space: pre-wrap;
        }

        .dark .explanation-text {
            color: #d1d5db;
        }

        .result-message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
            font-weight: 600;
            text-align: left;
        }

        .result-message.correct {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }

        .dark .result-message.correct {
            background: #064e3b;
            color: #a7f3d0;
            border-color: #10b981;
        }

        .result-message.incorrect {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #ef4444;
        }

        .dark .result-message.incorrect {
            background: #7f1d1d;
            color: #fecaca;
            border-color: #ef4444;
        }

        /* ===== BACK BUTTON STYLES ===== */
        .back-button {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            font-family: 'Merriweather', serif;
        }

        .dark .back-button {
            color: #60a5fa;
        }

        .back-button:hover {
            text-decoration: underline;
        }

        /* ===== LOADING SPINNER ===== */
        .loading-spinner {
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        .dark .loading-spinner {
            border-color: #374151;
            border-top-color: #3b82f6;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ===== ERROR MESSAGE ===== */
        .error-message {
            width: 98%;
            margin: 2rem auto;
            padding: 1.5rem;
            background: #fee2e2;
            border: 1px solid #ef4444;
            border-radius: 8px;
            color: #7f1d1d;
            text-align: center;
        }

        .dark .error-message {
            background: #7f1d1d;
            border-color: #ef4444;
            color: #fecaca;
        }

        /* ===== AUTHENTICATION MODAL ===== */
        #auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        #auth-modal.visible {
            display: flex;
        }

        .auth-modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .dark .auth-modal-content {
            background: #1f2937;
        }

        .auth-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .dark .auth-tabs {
            border-bottom-color: #374151;
        }

        .auth-tab {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .dark .auth-tab {
            color: #9ca3af;
        }

        .auth-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        .dark .auth-tab.active {
            color: #60a5fa;
            border-bottom-color: #60a5fa;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .auth-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 1rem;
            font-family: 'Merriweather', serif;
        }

        .dark .auth-input {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        .auth-submit-button {
            width: 100%;
            padding: 0.75rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-family: 'Merriweather', serif;
        }

        .dark .auth-submit-button {
            background: #1e40af;
        }

        .auth-submit-button:hover {
            background: #2563eb;
        }

        .dark .auth-submit-button:hover {
            background: #1d4ed8;
        }

        /* Hide scrollbar on content container */
        #content-container::-webkit-scrollbar {
            display: none;
        }

        #content-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>

<body class="h-full bg-gray-100 dark:bg-gray-900 flex items-center justify-center overflow-hidden">

    <!-- Splash Screen -->
    <div id="splash-screen">
        <img 
            src="https://i.postimg.cc/bw2vK1BT/Blue-Minimalist-Podcast-Youtube-Banner-20251225-022046-0001.png" 
            alt="ConceptBlitz Logo" 
            class="splash-logo"
            onerror="this.onerror=null; this.src='https://placehold.co/600x300/3B82F6/FFFFFF?text=ConceptBlitz';"
        >
    </div>

    <!-- Authentication Modal -->
    <div id="auth-modal">
        <div class="auth-modal-content">
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">Login</div>
                <div class="auth-tab" data-tab="register">Register</div>
            </div>
            
            <!-- Login Form -->
            <form id="login-form" class="auth-form active">
                <input type="email" id="login-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="login-password" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-submit-button" id="login-submit">Login</button>
            </form>
            
            <!-- Register Form -->
            <form id="register-form" class="auth-form">
                <input type="text" id="register-name" class="auth-input" placeholder="Full Name" required>
                <input type="email" id="register-email" class="auth-input" placeholder="Email" required>
                <input type="password" id="register-password" class="auth-input" placeholder="Password" required>
                <button type="submit" class="auth-submit-button" id="register-submit">Register</button>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-wrapper" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <button id="back-button" class="back-button hidden">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                    <path fill-rule="evenodd" d="M9.53 2.47a.75.75 0 0 1 0 1.06L4.06 9l5.47 5.47a.75.75 0 1 1-1.06 1.06l-6-6a.75.75 0 0 1 0-1.06l6-6a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
                </svg>
                Back
            </button>
            
            <div class="header-title">
                <span class="concept-text">Concept</span><span class="blitz-text">Blitz</span>
            </div>
            
            <div style="width: 80px;"></div> <!-- Spacer for alignment -->
        </header>

        <!-- Content Container -->
        <div id="content-container"></div>
    </div>

    <script>
        // ===== SPLASH SCREEN FUNCTIONALITY =====
        function hideSplashScreen() {
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) {
                // Add fade-out animation class
                splashScreen.classList.add('fade-out');
                
                // Hide splash screen after animation completes
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                    
                    // Show the main app wrapper
                    const appWrapper = document.getElementById('app-wrapper');
                    if (appWrapper) {
                        appWrapper.classList.remove('hidden');
                    }
                    
                    // Initialize the main app
                    initializeApp();
                }, 500);
            } else {
                // If no splash screen, initialize app directly
                initializeApp();
            }
        }

        // ===== MAIN APP INITIALIZATION =====
        function initializeApp() {
            // DOM Elements
            const contentContainer = document.getElementById('content-container');
            const backButton = document.getElementById('back-button');
            const headerTitle = document.querySelector('.header-title');
            const authModal = document.getElementById('auth-modal');
            const authTabs = document.querySelectorAll('.auth-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const loginSubmit = document.getElementById('login-submit');
            const registerSubmit = document.getElementById('register-submit');
            
            // App State
            let currentPage = 'home'; // 'home', 'chapter', 'questions'
            let currentSubject = null;
            let currentChapter = null;
            let currentCategory = null;
            let currentUser = null;
            let subjectImageUrl = null;
            
            // Default subject name (can be changed based on your requirements)
            const defaultSubject = 'mathematics';
            
            // Firebase Configuration
            const firebaseConfig = {
                apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
                authDomain: "geobazarr.firebaseapp.com",
                databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
                projectId: "geobazarr",
                storageBucket: "geobazarr.firebasestorage.app",
                messagingSenderId: "679949247383",
                appId: "1:679949247383:web:036d4f32038422ebb89ad2"
            };

            // Initialize Firebase
            let db, auth;
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                auth = firebase.auth();
                console.log("Firebase initialized successfully");
            } catch (error) {
                console.error("Firebase initialization error:", error);
                showError("Firebase initialization failed. Please refresh the page.");
            }

            // ===== HELPER FUNCTIONS =====
            function showError(message) {
                contentContainer.innerHTML = `
                    <div class="error-message">
                        ${message}
                        <button onclick="window.location.reload()" class="mt-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                            Refresh Page
                        </button>
                    </div>
                `;
            }

            function showLoading() {
                contentContainer.innerHTML = '<div class="loading-spinner"></div>';
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function formatTextWithLineBreaks(text) {
                if (!text) return '';
                const escaped = escapeHtml(text);
                return escaped.replace(/\n/g, '<br>');
            }

            function renderKaTeX(element) {
                if (typeof renderMathInElement === 'undefined') return;
                
                try {
                    renderMathInElement(element, {
                        delimiters: [
                            { left: '$$', right: '$$', display: true },
                            { left: '$', right: '$', display: false },
                            { left: '\\(', right: '\\)', display: false },
                            { left: '\\[', right: '\\]', display: true }
                        ],
                        throwOnError: false
                    });
                } catch (error) {
                    console.error("KaTeX rendering failed:", error);
                }
            }

            // ===== AUTHENTICATION FUNCTIONS =====
            function updateAuthUI() {
                const authButtonsContainer = document.querySelector('.auth-buttons-container');
                if (!authButtonsContainer) return;
                
                if (currentUser) {
                    authButtonsContainer.innerHTML = `
                        <button class="auth-button logout-button" onclick="handleLogout()">
                            Logout
                        </button>
                    `;
                } else {
                    authButtonsContainer.innerHTML = `
                        <button class="auth-button login-button" onclick="showAuthModal('login')">
                            Login
                        </button>
                        <button class="auth-button register-button" onclick="showAuthModal('register')">
                            Register
                        </button>
                    `;
                }
            }

            function showAuthModal(tab = 'login') {
                authModal.classList.add('visible');
                
                // Set active tab
                authTabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
                
                loginForm.classList.remove('active');
                registerForm.classList.remove('active');
                document.getElementById(`${tab}-form`).classList.add('active');
            }

            function hideAuthModal() {
                authModal.classList.remove('visible');
                // Clear form fields
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('register-name').value = '';
                document.getElementById('register-email').value = '';
                document.getElementById('register-password').value = '';
            }

            async function handleLogin(email, password) {
                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    currentUser = userCredential.user;
                    hideAuthModal();
                    updateAuthUI();
                    // Refresh current page to reflect auth state
                    if (currentPage === 'home') {
                        showHomePage();
                    }
                } catch (error) {
                    alert(getAuthErrorMessage(error));
                }
            }

            async function handleRegister(name, email, password) {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await userCredential.user.updateProfile({
                        displayName: name
                    });
                    currentUser = userCredential.user;
                    hideAuthModal();
                    updateAuthUI();
                    // Refresh current page to reflect auth state
                    if (currentPage === 'home') {
                        showHomePage();
                    }
                } catch (error) {
                    alert(getAuthErrorMessage(error));
                }
            }

            async function handleLogout() {
                try {
                    await auth.signOut();
                    currentUser = null;
                    updateAuthUI();
                    // Refresh current page to reflect auth state
                    if (currentPage === 'home') {
                        showHomePage();
                    }
                } catch (error) {
                    alert('Failed to logout. Please try again.');
                }
            }

            function getAuthErrorMessage(error) {
                switch (error.code) {
                    case 'auth/invalid-email':
                        return 'Invalid email address.';
                    case 'auth/user-disabled':
                        return 'This account has been disabled.';
                    case 'auth/user-not-found':
                        return 'No account found with this email.';
                    case 'auth/wrong-password':
                        return 'Incorrect password.';
                    case 'auth/email-already-in-use':
                        return 'An account with this email already exists.';
                    case 'auth/weak-password':
                        return 'Password is too weak.';
                    default:
                        return error.message || 'Authentication failed. Please try again.';
                }
            }

            // ===== PAGE NAVIGATION FUNCTIONS =====
            async function showHomePage() {
                currentPage = 'home';
                currentChapter = null;
                currentCategory = null;
                backButton.classList.add('hidden');
                
                showLoading();
                
                try {
                    // Fetch subject image
                    const subjectDoc = await db.collection('subjects').doc(defaultSubject).get();
                    if (!subjectDoc.exists) {
                        showError('Subject not found in database.');
                        return;
                    }
                    
                    const subjectData = subjectDoc.data();
                    subjectImageUrl = subjectData.imageUrl || 'https://placehold.co/600x400/3B82F6/FFFFFF?text=Subject+Image';
                    
                    // Fetch chapters
                    const chaptersSnapshot = await db.collection('subjects').doc(defaultSubject)
                        .collection('chapters').get();
                    
                    if (chaptersSnapshot.empty) {
                        contentContainer.innerHTML = `
                            <img src="${subjectImageUrl}" alt="Subject Image" class="subject-image">
                            <div class="error-message">
                                No chapters available for this subject.
                            </div>
                        `;
                        return;
                    }
                    
                    const chapters = [];
                    chaptersSnapshot.forEach(doc => {
                        chapters.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort chapters by order if available, otherwise by title
                    chapters.sort((a, b) => {
                        if (a.order !== undefined && b.order !== undefined) {
                            return a.order - b.order;
                        }
                        return (a.title || '').localeCompare(b.title || '');
                    });
                    
                    // Build home page HTML
                    let html = `
                        <img src="${subjectImageUrl}" alt="Subject Image" class="subject-image">
                        <div class="chapters-list">
                    `;
                    
                    chapters.forEach(chapter => {
                        html += `
                            <div class="chapter-item" data-chapter-id="${chapter.id}">
                                <div class="chapter-title">${chapter.title || 'Untitled Chapter'}</div>
                            </div>
                        `;
                    });
                    
                    html += `
                        </div>
                        <div class="auth-buttons-container"></div>
                    `;
                    
                    contentContainer.innerHTML = html;
                    
                    // Add event listeners to chapter items
                    document.querySelectorAll('.chapter-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const chapterId = item.getAttribute('data-chapter-id');
                            const chapter = chapters.find(c => c.id === chapterId);
                            showChapterPage(chapter);
                        });
                    });
                    
                    // Update auth UI
                    updateAuthUI();
                    
                } catch (error) {
                    console.error('Error loading home page:', error);
                    showError('Failed to load content. Please check your connection.');
                }
            }

            async function showChapterPage(chapter) {
                currentPage = 'chapter';
                currentChapter = chapter;
                backButton.classList.remove('hidden');
                
                showLoading();
                
                try {
                    // Fetch categories for this chapter
                    const categoriesSnapshot = await db.collection('subjects').doc(defaultSubject)
                        .collection('chapters').doc(chapter.id)
                        .collection('categories').get();
                    
                    if (categoriesSnapshot.empty) {
                        contentContainer.innerHTML = `
                            <div class="error-message">
                                No categories available for this chapter.
                            </div>
                        `;
                        return;
                    }
                    
                    const categories = [];
                    categoriesSnapshot.forEach(doc => {
                        categories.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort categories by order if available, otherwise by title
                    categories.sort((a, b) => {
                        if (a.order !== undefined && b.order !== undefined) {
                            return a.order - b.order;
                        }
                        return (a.title || '').localeCompare(b.title || '');
                    });
                    
                    // Build chapter page HTML
                    let html = '<div class="categories-list">';
                    
                    categories.forEach(category => {
                        html += `
                            <div class="category-item" data-category-id="${category.id}">
                                <div class="category-title">${category.title || 'Untitled Category'}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    contentContainer.innerHTML = html;
                    
                    // Add event listeners to category items
                    document.querySelectorAll('.category-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const categoryId = item.getAttribute('data-category-id');
                            const category = categories.find(c => c.id === categoryId);
                            showQuestionsPage(category);
                        });
                    });
                    
                } catch (error) {
                    console.error('Error loading chapter page:', error);
                    showError('Failed to load categories. Please check your connection.');
                }
            }

            async function showQuestionsPage(category) {
                currentPage = 'questions';
                currentCategory = category;
                backButton.classList.remove('hidden');
                
                showLoading();
                
                try {
                    // Fetch questions for this category
                    const questionsSnapshot = await db.collection('subjects').doc(defaultSubject)
                        .collection('chapters').doc(currentChapter.id)
                        .collection('categories').doc(category.id)
                        .collection('questions').get();
                    
                    if (questionsSnapshot.empty) {
                        contentContainer.innerHTML = `
                            <div class="category-header">
                                <div class="category-name">${category.title || 'Untitled Category'}</div>
                            </div>
                            <div class="error-message">
                                No questions available for this category.
                            </div>
                        `;
                        return;
                    }
                    
                    const questions = [];
                    questionsSnapshot.forEach(doc => {
                        questions.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    // Sort questions by order if available
                    questions.sort((a, b) => {
                        if (a.order !== undefined && b.order !== undefined) {
                            return a.order - b.order;
                        }
                        return 0;
                    });
                    
                    // Build questions page HTML
                    let html = `
                        <div class="category-header">
                            <div class="category-name">${category.title || 'Untitled Category'}</div>
                        </div>
                        <div class="questions-list">
                    `;
                    
                    questions.forEach((question, index) => {
                        html += `
                            <div class="question-item" data-question-id="${question.id}">
                                <div class="question-text latex-content">
                                    ${formatTextWithLineBreaks(question.text || 'No question text')}
                                </div>
                                
                                ${question.imageUrl ? `
                                    <img src="${question.imageUrl}" alt="Question image" 
                                         style="width: 100%; max-width: 400px; margin: 1rem 0; border-radius: 8px;"
                                         onerror="this.src='https://placehold.co/600x400/F59E0B/FFFFFF?text=Question+Image'">
                                ` : ''}
                                
                                <div class="options-container">
                                    ${question.options && question.options.length > 0 ? 
                                        question.options.map((option, optionIndex) => `
                                            <div class="option-item" data-option-index="${optionIndex}">
                                                <div class="option-marker">${String.fromCharCode(65 + optionIndex)}</div>
                                                <div class="option-text latex-content">
                                                    ${formatTextWithLineBreaks(option || 'No option text')}
                                                </div>
                                            </div>
                                        `).join('') : 
                                        '<p>No options available</p>'
                                    }
                                </div>
                                
                                <button class="submit-button" disabled>Submit Answer</button>
                                
                                <div class="explanation-section">
                                    <div class="result-message"></div>
                                    <div class="explanation-title">Explanation:</div>
                                    <div class="explanation-text latex-content">
                                        ${formatTextWithLineBreaks(question.explanation || 'No explanation available')}
                                    </div>
                                    
                                    ${question.explanationImageUrl ? `
                                        <img src="${question.explanationImageUrl}" alt="Explanation image" 
                                             style="width: 100%; max-width: 400px; margin: 1rem 0; border-radius: 8px;"
                                             onerror="this.src='https://placehold.co/600x400/10B981/FFFFFF?text=Explanation+Image'">
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    contentContainer.innerHTML = html;
                    
                    // Add event listeners to questions
                    setupQuestionsListeners();
                    
                    // Render LaTeX
                    setTimeout(() => {
                        renderKaTeX(contentContainer);
                    }, 100);
                    
                } catch (error) {
                    console.error('Error loading questions page:', error);
                    showError('Failed to load questions. Please check your connection.');
                }
            }

            function setupQuestionsListeners() {
                // Setup option selection
                document.querySelectorAll('.option-item').forEach(option => {
                    option.addEventListener('click', function() {
                        const questionItem = this.closest('.question-item');
                        
                        // Remove selected class from all options in this question
                        questionItem.querySelectorAll('.option-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        // Add selected class to clicked option
                        this.classList.add('selected');
                        
                        // Enable submit button for this question
                        const submitButton = questionItem.querySelector('.submit-button');
                        submitButton.disabled = false;
                    });
                });
                
                // Setup submit button handlers
                document.querySelectorAll('.submit-button').forEach(button => {
                    button.addEventListener('click', function() {
                        const questionItem = this.closest('.question-item');
                        const questionId = questionItem.getAttribute('data-question-id');
                        const selectedOption = questionItem.querySelector('.option-item.selected');
                        
                        if (!selectedOption) return;
                        
                        const selectedIndex = parseInt(selectedOption.getAttribute('data-option-index'));
                        
                        // For now, we'll assume correctIndex is stored in the question data
                        // In a real app, you would fetch this from Firebase
                        // Since we don't have the correctIndex in our current structure,
                        // we'll use a placeholder logic
                        
                        // For demo purposes, let's assume the first option (index 0) is correct
                        const correctIndex = 0;
                        
                        // Disable all options and submit button
                        questionItem.querySelectorAll('.option-item').forEach(item => {
                            item.style.cursor = 'default';
                        });
                        this.disabled = true;
                        
                        // Show correct/incorrect styling
                        questionItem.querySelectorAll('.option-item').forEach(item => {
                            const itemIndex = parseInt(item.getAttribute('data-option-index'));
                            if (itemIndex === correctIndex) {
                                item.classList.add('correct');
                            } else if (itemIndex === selectedIndex && itemIndex !== correctIndex) {
                                item.classList.add('incorrect');
                            }
                        });
                        
                        // Show result message
                        const resultMessage = questionItem.querySelector('.result-message');
                        const explanationSection = questionItem.querySelector('.explanation-section');
                        
                        if (selectedIndex === correctIndex) {
                            resultMessage.textContent = 'Correct! Well done!';
                            resultMessage.className = 'result-message correct';
                        } else {
                            resultMessage.textContent = `Incorrect. The correct answer is ${String.fromCharCode(65 + correctIndex)}.`;
                            resultMessage.className = 'result-message incorrect';
                        }
                        
                        // Show explanation
                        explanationSection.classList.add('show');
                        
                        // Re-render LaTeX in the explanation section
                        setTimeout(() => {
                            renderKaTeX(explanationSection);
                        }, 50);
                    });
                });
            }

            // ===== EVENT LISTENERS =====
            backButton.addEventListener('click', () => {
                if (currentPage === 'questions') {
                    showChapterPage(currentChapter);
                } else if (currentPage === 'chapter') {
                    showHomePage();
                }
            });

            // Auth modal tab switching
            authTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabName = tab.getAttribute('data-tab');
                    authTabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    loginForm.classList.remove('active');
                    registerForm.classList.remove('active');
                    document.getElementById(`${tabName}-form`).classList.add('active');
                });
            });

            // Auth form submissions
            loginForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                handleLogin(email, password);
            });

            registerForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('register-name').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                handleRegister(name, email, password);
            });

            // Close auth modal when clicking outside
            authModal.addEventListener('click', (e) => {
                if (e.target === authModal) {
                    hideAuthModal();
                }
            });

            // ===== FIREBASE AUTH STATE CHANGE =====
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                updateAuthUI();
                
                // If we're on home page, refresh to update auth buttons
                if (currentPage === 'home' && contentContainer.innerHTML) {
                    updateAuthUI();
                }
            });

            // ===== INITIALIZE APP =====
            showHomePage();
        }

        // ===== GLOBAL FUNCTIONS (accessible from HTML) =====
        window.showAuthModal = function(tab) {
            const authModal = document.getElementById('auth-modal');
            const authTabs = document.querySelectorAll('.auth-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            
            authModal.classList.add('visible');
            
            // Set active tab
            authTabs.forEach(t => t.classList.remove('active'));
            document.querySelector(`.auth-tab[data-tab="${tab}"]`).classList.add('active');
            
            loginForm.classList.remove('active');
            registerForm.classList.remove('active');
            document.getElementById(`${tab}-form`).classList.add('active');
        };

        window.handleLogout = async function() {
            try {
                const auth = firebase.auth();
                await auth.signOut();
                // The auth state change listener will handle UI updates
            } catch (error) {
                alert('Failed to logout. Please try again.');
            }
        };

        // ===== START SPLASH SCREEN TIMER =====
        window.addEventListener('load', () => {
            // Initialize Firebase early
            const firebaseConfig = {
                apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
                authDomain: "geobazarr.firebaseapp.com",
                databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
                projectId: "geobazarr",
                storageBucket: "geobazarr.firebasestorage.app",
                messagingSenderId: "679949247383",
                appId: "1:679949247383:web:036d4f32038422ebb89ad2"
            };
            
            try {
                firebase.initializeApp(firebaseConfig);
                console.log("Firebase initialized during splash screen");
            } catch (error) {
                console.error("Firebase initialization error:", error);
            }
            
            // Hide splash screen after 2.5 seconds
            setTimeout(hideSplashScreen, 2500);
            
            const splashScreen = document.getElementById('splash-screen');
            if (splashScreen) {
                splashScreen.addEventListener('click', () => {
                    hideSplashScreen();
                });
            }
        });
    </script>
</body>
</html>
